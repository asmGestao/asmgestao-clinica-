<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM Fisioterapia - Dra. Andresa Augusto</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
        }
        
        .header {
            background: #264653;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: #2a9d8f;
            flex-wrap: wrap;
        }
        
        .nav button {
            padding: 10px 20px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .nav button:hover, .nav button.active {
            background: white;
            color: #264653;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section.active { display: block; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn-primary { background: #2a9d8f; color: white; }
        .btn-success { background: #52b788; color: white; }
        .btn-danger { background: #e76f51; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .card:hover {
            border-color: #2a9d8f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #264653;
            color: white;
        }
        
        .calendar-day {
            background: #f8f9fa;
            min-height: 100px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .calendar-day:hover { background: #e9ecef; }
        
        .appointment {
            background: #2a9d8f;
            color: white;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th { background: #f8f9fa; font-weight: bold; }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }
        
        .summary-card.green { background: #52b788; }
        .summary-card.red { background: #e76f51; }
        .summary-card.blue { background: #264653; }
        
        .summary-card h3 { font-size: 32px; margin-bottom: 5px; }
        .summary-card p { font-size: 14px; opacity: 0.9; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        
        .tab.active {
            color: #2a9d8f;
            border-bottom: 2px solid #2a9d8f;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .report-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè• ASM Fisioterapia</h1>
        <p>Dra. Andresa Augusto - Gest√£o Cl√≠nica</p>
    </div>
    
    <div class="nav">
        <button class="active" onclick="showSection('agenda')">üìÖ Agenda</button>
        <button onclick="showSection('pacientes')">üë• Pacientes</button>
        <button onclick="showSection('financeiro')">üí∞ Financeiro</button>
        <button onclick="showSection('fluxo')">üìä Fluxo de Caixa</button>
        <button onclick="showSection('relatorios')">üìà Relat√≥rios</button>
    </div>
    
    <div class="container">
        <!-- AGENDA -->
        <div id="agenda" class="section active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Agenda de Atendimentos</h2>
                <button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê Anterior</button>
                <h3 id="currentMonth"></h3>
                <button class="btn btn-primary" onclick="changeMonth(1)">Pr√≥ximo ‚Üí</button>
            </div>
            
            <div class="calendar" id="calendar"></div>
        </div>
        
        <!-- PACIENTES -->
        <div id="pacientes" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Cadastro de Pacientes</h2>
                <button class="btn btn-primary" onclick="openPatientModal()">+ Novo Paciente</button>
            </div>
            
            <input type="text" style="width: 100%; padding: 10px; margin-bottom: 20px;" placeholder="Buscar paciente..." oninput="searchPatients(this.value)">
            
            <div class="grid" id="patientsList"></div>
        </div>
        
        <!-- FINANCEIRO -->
        <div id="financeiro" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Controle Financeiro</h2>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar Excel</button>
            </div>
            
            <div class="summary-cards">
                <div class="summary-card green">
                    <h3 id="totalReceived">R$ 0,00</h3>
                    <p>Total Recebido</p>
                </div>
                <div class="summary-card red">
                    <h3 id="totalPending">R$ 0,00</h3>
                    <p>Total a Receber</p>
                </div>
                <div class="summary-card blue">
                    <h3 id="totalSessions">0</h3>
                    <p>Total de Sess√µes</p>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>Data</th>
                        <th>Servi√ßo</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="financialTable"></tbody>
            </table>
        </div>
        
        <!-- FLUXO DE CAIXA -->
        <div id="fluxo" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Fluxo de Caixa</h2>
                <button class="btn btn-primary" onclick="openExpenseModal()">+ Nova Despesa</button>
            </div>
            
            <div class="form-group">
                <label>M√™s/Ano</label>
                <input type="month" id="cashFlowMonth" onchange="renderCashFlow()">
            </div>
            
            <div class="summary-cards">
                <div class="summary-card green">
                    <h3 id="cfEntries">R$ 0,00</h3>
                    <p>Entradas</p>
                </div>
                <div class="summary-card red">
                    <h3 id="cfExits">R$ 0,00</h3>
                    <p>Sa√≠das</p>
                </div>
                <div class="summary-card blue">
                    <h3 id="cfBalance">R$ 0,00</h3>
                    <p>Saldo</p>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showCashFlowTab('entries')">Entradas</button>
                <button class="tab" onclick="showCashFlowTab('exits')">Despesas</button>
            </div>
            
            <div id="cfEntriesTab" class="tab-content active">
                <table>
                    <thead>
                        <tr><th>Data</th><th>Paciente</th><th>Servi√ßo</th><th>Valor</th></tr>
                    </thead>
                    <tbody id="entriesTable"></tbody>
                </table>
            </div>
            
            <div id="cfExitsTab" class="tab-content">
                <table>
                    <thead>
                        <tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr>
                    </thead>
                    <tbody id="exitsTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- RELAT√ìRIOS -->
        <div id="relatorios" class="section">
            <h2>Relat√≥rios de Gest√£o</h2>
            
            <div class="form-group">
                <label>M√™s/Ano</label>
                <input type="month" id="reportMonth" onchange="renderReports()">
            </div>
            
            <div class="summary-cards">
                <div class="summary-card blue">
                    <h3 id="reportSessions">0</h3>
                    <p>Atendimentos</p>
                </div>
                <div class="summary-card green">
                    <h3 id="reportRevenue">R$ 0,00</h3>
                    <p>Faturamento</p>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">Pacientes Atendidos</h3>
            <table>
                <thead>
                    <tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr>
                </thead>
                <tbody id="reportTable"></tbody>
            </table>
        </div>
    </div>
    
    <!-- MODAL AGENDAMENTO -->
    <div class="modal" id="appointmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agendamento</h3>
                <button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Paciente *</label>
                <select id="apptPatient"></select>
            </div>
            
            <div class="form-group">
                <label>Data *</label>
                <input type="date" id="apptDate">
            </div>
            
            <div class="form-group">
                <label>Hor√°rio *</label>
                <input type="time" id="apptTime">
            </div>
            
            <div class="form-group">
                <label>Tipo</label>
                <select id="apptType">
                    <option value="normal">Normal</option>
                    <option value="laser">Com Laser</option>
                    <option value="avaliacao">Avalia√ß√£o</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Valor (R$)</label>
                <input type="number" id="apptValue" step="0.01">
            </div>
            
            <div class="form-group">
                <label>Observa√ß√µes</label>
                <textarea id="apptNotes" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-whatsapp" id="btnWhatsAppt" onclick="sendAppointmentWhatsApp()" style="display: none;">üì± WhatsApp</button>
                <button class="btn btn-primary" onclick="saveAppointment()" style="margin-left: auto;">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PACIENTE -->
    <div class="modal" id="patientModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="patientModalTitle">Novo Paciente</h3>
                <button class="close-btn" onclick="closeModal('patientModal')">&times;</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showPatientTab('info')">Informa√ß√µes</button>
                <button class="tab" onclick="showPatientTab('financeiro')">Financeiro</button>
                <button class="tab" onclick="showPatientTab('evolucao')">Evolu√ß√£o</button>
                <button class="tab" onclick="showPatientTab('relatorio')">Relat√≥rio Mensal</button>
            </div>
            
            <!-- ABA INFO -->
            <div id="tabInfo" class="tab-content active">
                <input type="hidden" id="patientId">
                
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="patientName">
                </div>
                
                <div class="form-group">
                    <label>Telefone *</label>
                    <input type="tel" id="patientPhone" placeholder="(00) 00000-0000">
                </div>
                
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="patientEmail">
                </div>
                
                <div class="form-group">
                    <label>Valor Padr√£o (R$)</label>
                    <input type="number" id="patientValue" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Queixa Principal</label>
                    <textarea id="patientComplaint" rows="3"></textarea>
                </div>
            </div>
            
            <!-- ABA FINANCEIRO -->
            <div id="tabFinanceiro" class="tab-content">
                <div class="summary-cards">
                    <div class="summary-card green">
                        <h3 id="patientPaid">R$ 0,00</h3>
                        <p>Pago</p>
                    </div>
                    <div class="summary-card red">
                        <h3 id="patientPending">R$ 0,00</h3>
                        <p>Pendente</p>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr><th>Data</th><th>Servi√ßo</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr>
                    </thead>
                    <tbody id="patientFinanceTable"></tbody>
                </table>
            </div>
            
            <!-- ABA EVOLU√á√ÉO -->
            <div id="tabEvolucao" class="tab-content">
                <div class="form-group">
                    <label>Nova Evolu√ß√£o</label>
                    <textarea id="newEvolution" rows="4" placeholder="Descreva a evolu√ß√£o do paciente..."></textarea>
                    <button class="btn btn-primary" onclick="addEvolution()" style="margin-top: 10px;">Salvar Evolu√ß√£o</button>
                </div>
                
                <div id="evolutionsList" style="margin-top: 20px;"></div>
            </div>
            
            <!-- ABA RELAT√ìRIO -->
            <div id="tabRelatorio" class="tab-content">
                <div class="form-group">
                    <label>M√™s/Ano do Relat√≥rio</label>
                    <input type="month" id="reportMonthPatient">
                </div>
                
                <button class="btn btn-primary" onclick="generatePatientReport()">üü¢ Gerar Relat√≥rio Mensal</button>
                
                <div id="reportContainer" style="display: none; margin-top: 20px;">
                    <div class="report-box" id="reportContent"></div>
                    <button class="btn btn-primary" onclick="copyReport()">üìã Copiar</button>
                    <button class="btn btn-whatsapp" onclick="sendReportWhatsApp()">üì± Enviar WhatsApp</button>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()">Excluir</button>
                <button class="btn btn-primary" onclick="savePatient()">Salvar Paciente</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DESPESA -->
    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nova Despesa</h3>
                <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Data *</label>
                <input type="date" id="expenseDate">
            </div>
            
            <div class="form-group">
                <label>Descri√ß√£o *</label>
                <input type="text" id="expenseDesc" placeholder="Ex: Aluguel, Material...">
            </div>
            
            <div class="form-group">
                <label>Categoria</label>
                <select id="expenseCategory">
                    <option value="material">Material/Equipamento</option>
                    <option value="aluguel">Aluguel</option>
                    <option value="servicos">Servi√ßos</option>
                    <option value="outros">Outros</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Valor (R$) *</label>
                <input type="number" id="expenseValue" step="0.01">
            </div>
            
            <button class="btn btn-primary" onclick="saveExpense()">Salvar Despesa</button>
        </div>
    </div>

    <script>
// DADOS
        let patients = JSON.parse(localStorage.getItem('asm_patients')) || [];
        let appointments = JSON.parse(localStorage.getItem('asm_appointments')) || [];
        let evolutions = JSON.parse(localStorage.getItem('asm_evolutions')) || [];
        let expenses = JSON.parse(localStorage.getItem('asm_expenses')) || [];
        
        let currentDate = new Date();
        let currentPatientId = null;
        let currentApptId = null;
        let currentReport = '';

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            renderCalendar();
            renderPatients();
            updateFinancialSummary();
            loadPatientSelect();
            
            const today = new Date().toISOString().slice(0, 7);
            document.getElementById('cashFlowMonth').value = today;
            document.getElementById('reportMonth').value = today;
        });

        // NAVEGA√á√ÉO
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            if (section === 'financeiro') renderFinancialTable();
            if (section === 'fluxo') renderCashFlow();
            if (section === 'relatorios') renderReports();
        }

        // CALEND√ÅRIO
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            days.forEach(day => {
                const div = document.createElement('div');
                div.className = 'calendar-header';
                div.textContent = day;
                calendar.appendChild(div);
            });
            
            for (let i = 0; i < firstDay; i++) {
                calendar.appendChild(document.createElement('div'));
            }
            
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerHTML = '<strong>' + day + '</strong>';
                
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    div.style.background = '#2a9d8f';
                    div.style.color = 'white';
                }
                
                // CORRE√á√ÉO DO BUG DE DATA
                const dayAppointments = appointments.filter(a => {
                    const parts = a.date.split('-');
                    const y = parseInt(parts[0]);
                    const m = parseInt(parts[1]);
                    const d = parseInt(parts[2]);
                    return y === year && (m - 1) === month && d === day;
                });
                
                dayAppointments.forEach(appt => {
                    const patient = patients.find(p => p.id === appt.patientId);
                    const apptDiv = document.createElement('div');
                    apptDiv.className = 'appointment';
                    apptDiv.textContent = appt.time + ' ' + (patient ? patient.name.split(' ')[0] : '');
                    apptDiv.onclick = function(e) {
                        e.stopPropagation();
                        editAppointment(appt.id);
                    };
                    div.appendChild(apptDiv);
                });
                
                div.onclick = function() {
                    openAppointmentModal(year, month, day);
                };
                calendar.appendChild(div);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // PACIENTES
        function renderPatients() {
            const list = document.getElementById('patientsList');
            list.innerHTML = '';
            
            patients.forEach(p => {
                const patientAppts = appointments.filter(a => a.patientId === p.id);
                const pending = patientAppts.filter(a => !a.paid).length;
                
                const card = document.createElement('div');
                card.className = 'card';
                let html = '<h3>' + p.name + '</h3>';
                html += '<p>üì± ' + p.phone + '</p>';
                html += '<p>üí∞ R$ ' + parseFloat(p.defaultValue || 0).toFixed(2) + '</p>';
                if (pending > 0) {
                    html += '<p style="color: #e76f51;">‚ö†Ô∏è ' + pending + ' pendente(s)</p>';
                }
                card.innerHTML = html;
                card.onclick = function() {
                    openPatientModal(p.id);
                };
                list.appendChild(card);
            });
        }

        function searchPatients(term) {
            const cards = document.querySelectorAll('#patientsList .card');
            cards.forEach(card => {
                const name = card.querySelector('h3').textContent.toLowerCase();
                card.style.display = name.includes(term.toLowerCase()) ? 'block' : 'none';
            });
        }

        function openPatientModal(patientId) {
            currentPatientId = patientId;
            const modal = document.getElementById('patientModal');
            
            // Reset
            document.getElementById('patientId').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientEmail').value = '';
            document.getElementById('patientValue').value = '';
            document.getElementById('patientComplaint').value = '';
            
            showPatientTab('info');
            
            if (patientId) {
                const p = patients.find(x => x.id === patientId);
                document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
                document.getElementById('patientId').value = p.id;
                document.getElementById('patientName').value = p.name;
                document.getElementById('patientPhone').value = p.phone;
                document.getElementById('patientEmail').value = p.email || '';
                document.getElementById('patientValue').value = p.defaultValue || '';
                document.getElementById('patientComplaint').value = p.complaint || '';
                document.getElementById('btnDeletePatient').style.display = 'block';
                
                renderPatientFinance();
                renderEvolutions();
            } else {
                document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
                document.getElementById('btnDeletePatient').style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function savePatient() {
            const id = document.getElementById('patientId').value;
            const data = {
                id: id || Date.now().toString(),
                name: document.getElementById('patientName').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                defaultValue: document.getElementById('patientValue').value,
                complaint: document.getElementById('patientComplaint').value
            };
            
            if (!data.name || !data.phone) {
                alert('Preencha nome e telefone!');
                return;
            }
            
            if (id) {
                const idx = patients.findIndex(p => p.id === id);
                patients[idx] = data;
            } else {
                patients.push(data);
            }
            
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            closeModal('patientModal');
            renderPatients();
            loadPatientSelect();
        }

        function deletePatient() {
            if (!confirm('Excluir paciente e todos os dados?')) return;
            
            patients = patients.filter(p => p.id !== currentPatientId);
            appointments = appointments.filter(a => a.patientId !== currentPatientId);
            evolutions = evolutions.filter(e => e.patientId !== currentPatientId);
            
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            
            closeModal('patientModal');
            renderPatients();
            renderCalendar();
            updateFinancialSummary();
        }

        function showPatientTab(tab) {
            document.querySelectorAll('#patientModal .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            if (tab === 'financeiro') renderPatientFinance();
            if (tab === 'evolucao') renderEvolutions();
        }

        // AGENDAMENTOS
        function openAppointmentModal(year, month, day) {
            currentApptId = null;
            document.getElementById('apptPatient').value = '';
            document.getElementById('apptTime').value = '';
            document.getElementById('apptValue').value = '';
            document.getElementById('apptNotes').value = '';
            document.getElementById('btnWhatsAppt').style.display = 'none';
            
            if (year !== undefined) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                document.getElementById('apptDate').value = dateStr;
            } else {
                document.getElementById('apptDate').value = new Date().toISOString().split('T')[0];
            }
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function editAppointment(id) {
            const appt = appointments.find(a => a.id === id);
            currentApptId = id;
            
            document.getElementById('apptPatient').value = appt.patientId;
            document.getElementById('apptDate').value = appt.date;
            document.getElementById('apptTime').value = appt.time;
            document.getElementById('apptType').value = appt.type;
            document.getElementById('apptValue').value = appt.value;
            document.getElementById('apptNotes').value = appt.notes || '';
            document.getElementById('btnWhatsAppt').style.display = 'inline-block';
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function saveAppointment() {
            const patientId = document.getElementById('apptPatient').value;
            if (!patientId) {
                alert('Selecione um paciente!');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            const data = {
                id: currentApptId || Date.now().toString(),
                patientId: patientId,
                date: document.getElementById('apptDate').value,
                time: document.getElementById('apptTime').value,
                type: document.getElementById('apptType').value,
                value: document.getElementById('apptValue').value || patient.defaultValue || 0,
                notes: document.getElementById('apptNotes').value,
                paid: currentApptId ? appointments.find(a => a.id === currentApptId).paid : false
            };
            
            if (currentApptId) {
                const idx = appointments.findIndex(a => a.id === currentApptId);
                appointments[idx] = data;
            } else {
                appointments.push(data);
            }
            
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            closeModal('appointmentModal');
            renderCalendar();
            updateFinancialSummary();
        }

        function sendAppointmentWhatsApp() {
            if (!currentApptId) return;
            
            const appt = appointments.find(a => a.id === currentApptId);
            const patient = patients.find(p => p.id === appt.patientId);
            
            const msg = 'Ol√° ' + patient.name + ',\n\nLembramos que voc√™ tem agendamento na ASM Fisioterapia com Dra. Andresa Augusto.\n\nüìÖ Data: ' + formatDate(appt.date) + '\n‚è∞ Hor√°rio: ' + appt.time + '\n\nAguardamos voc√™! üíö';
            
            window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }

        // FINANCEIRO
        function renderFinancialTable() {
            const tbody = document.getElementById('financialTable');
            tbody.innerHTML = '';
            
            const sorted = appointments.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(appt => {
                const patient = patients.find(p => p.id === appt.patientId);
                const row = document.createElement('tr');
                
                let html = '<td>' + (patient ? patient.name : '-') + '</td>';
                html += '<td>' + formatDate(appt.date) + '</td>';
                html += '<td>' + (appt.type === 'laser' ? 'Laser' : 'Normal') + '</td>';
                html += '<td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td>';
                html += '<td>' + (appt.paid ? '‚úÖ Pago' : '‚è≥ Pendente') + '</td>';
                html += '<td><button class="btn btn-primary" onclick="togglePayment(\'' + appt.id + '\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        function renderPatientFinance() {
            const patientAppts = appointments.filter(a => a.patientId === currentPatientId);
            const paid = patientAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const pending = patientAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('patientPaid').textContent = 'R$ ' + paid.toFixed(2);
            document.getElementById('patientPending').textContent = 'R$ ' + pending.toFixed(2);
            
            const tbody = document.getElementById('patientFinanceTable');
            tbody.innerHTML = '';
            
            patientAppts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            patientAppts.forEach(appt => {
                const row = document.createElement('tr');
                let html = '<td>' + formatDate(appt.date) + '</td>';
                html += '<td>' + appt.type + '</td>';
                html += '<td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td>';
                html += '<td>' + (appt.paid ? 'Pago' : 'Pendente') + '</td>';
                html += '<td><button class="btn btn-primary" onclick="togglePayment(\'' + appt.id + '\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        function updateFinancialSummary() {
            const received = appointments.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const pending = appointments.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('totalReceived').textContent = 'R$ ' + received.toFixed(2);
            document.getElementById('totalPending').textContent = 'R$ ' + pending.toFixed(2);
            document.getElementById('totalSessions').textContent = appointments.length;
        }

        function togglePayment(id) {
            const appt = appointments.find(a => a.id === id);
            appt.paid = !appt.paid;
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            
            renderFinancialTable();
            updateFinancialSummary();
            renderCalendar();
            if (currentPatientId) renderPatientFinance();
        }

        // EVOLU√á√ïES
        function renderEvolutions() {
            const list = document.getElementById('evolutionsList');
            list.innerHTML = '';
            
            const patientEvos = evolutions.filter(e => e.patientId === currentPatientId)
                .sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
            
            patientEvos.forEach(evo => {
                const div = document.createElement('div');
                div.style.cssText = 'background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #2a9d8f;';
                div.innerHTML = '<small style="color: #666;">' + formatDate(evo.date) + ' √†s ' + evo.time + '</small><p style="margin-top: 5px;">' + evo.text + '</p>';
                list.appendChild(div);
            });
        }

        function addEvolution() {
            const text = document.getElementById('newEvolution').value;
            if (!text.trim()) return;
            
            const now = new Date();
            const evo = {
                id: Date.now().toString(),
                patientId: currentPatientId,
                date: now.toISOString().split('T')[0],
                time: now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                text: text
            };
            
            evolutions.push(evo);
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            
            document.getElementById('newEvolution').value = '';
            renderEvolutions();
        }

        // RELAT√ìRIO DO PACIENTE
        function generatePatientReport() {
            const month = document.getElementById('reportMonthPatient').value;
            if (!month) {
                alert('Selecione o m√™s!');
                return;
            }
            
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            const patient = patients.find(p => p.id === currentPatientId);
            
            const monthEvos = evolutions.filter(e => {
                if (e.patientId !== currentPatientId) return false;
                const ep = e.date.split('-');
                return parseInt(ep[0]) === year && parseInt(ep[1]) === mon;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const monthAppts = appointments.filter(a => {
                if (a.patientId !== currentPatientId) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            let report = 'RELAT√ìRIO MENSAL - ASM FISIOTERAPIA\n';
            report += 'Dra. Andresa Augusto\n';
            report += '================================\n\n';
            report += 'Paciente: ' + patient.name + '\n';
            report += 'Per√≠odo: ' + monthName + '\n\n';
            report += 'üìã RESUMO\n';
            report += 'Sess√µes realizadas: ' + monthAppts.length + '\n\n';
            
            if (monthAppts.length > 0) {
                report += 'Datas das sess√µes:\n';
                monthAppts.forEach(a => {
                    report += '‚Ä¢ ' + formatDate(a.date) + ' - ' + a.time + '\n';
                });
                report += '\n';
            }
            
            report += 'üìä EVOLU√á√ÉO CL√çNICA\n\n';
            
            if (monthEvos.length === 0) {
                report += 'Nenhuma evolu√ß√£o registrada neste per√≠odo.\n';
            } else {
                monthEvos.forEach((evo, i) => {
                    report += 'Sess√£o ' + (i + 1) + ' - ' + formatDate(evo.date) + '\n';
                    report += evo.text + '\n';
                    report += '--------------------------------\n\n';
                });
            }
            
            report += '\nüíö Agradecemos a confian√ßa!\nASM Fisioterapia';
            
            currentReport = report;
            document.getElementById('reportContent').textContent = report;
            document.getElementById('reportContainer').style.display = 'block';
        }

        function copyReport() {
            navigator.clipboard.writeText(currentReport).then(() => alert('Copiado!'));
        }

        function sendReportWhatsApp() {
            const patient = patients.find(p => p.id === currentPatientId);
            window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(currentReport), '_blank');
        }

        // FLUXO DE CAIXA
        function openExpenseModal() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseModal').classList.add('active');
        }

        function saveExpense() {
            const data = {
                id: Date.now().toString(),
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDesc').value,
                category: document.getElementById('expenseCategory').value,
                value: parseFloat(document.getElementById('expenseValue').value)
            };
            
            if (!data.date || !data.description || !data.value) {
                alert('Preencha todos os campos!');
                return;
            }
            
            expenses.push(data);
            localStorage.setItem('asm_expenses', JSON.stringify(expenses));
            
            closeModal('expenseModal');
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseValue').value = '';
            renderCashFlow();
        }

        function showCashFlowTab(tab) {
            document.querySelectorAll('#fluxo .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#fluxo .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('cf' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.add('active');
        }

        function renderCashFlow() {
            const month = document.getElementById('cashFlowMonth').value;
            if (!month) return;
            
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            
            const entries = appointments.filter(a => {
                if (!a.paid) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const exits = expenses.filter(e => {
                const ep = e.date.split('-');
                return parseInt(ep[0]) === year && parseInt(ep[1]) === mon;
            });
            
            const totalEntries = entries.reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const totalExits = exits.reduce((s, e) => s + parseFloat(e.value || 0), 0);
            
            document.getElementById('cfEntries').textContent = 'R$ ' + totalEntries.toFixed(2);
            document.getElementById('cfExits').textContent = 'R$ ' + totalExits.toFixed(2);
            document.getElementById('cfBalance').textContent = 'R$ ' + (totalEntries - totalExits).toFixed(2);
            
            // Entries table
            const entriesBody = document.getElementById('entriesTable');
            entriesBody.innerHTML = '';
            entries.forEach(a => {
                const p = patients.find(x => x.id === a.patientId);
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + formatDate(a.date) + '</td><td>' + (p ? p.name : '-') + '</td><td>' + a.type + '</td><td>R$ ' + parseFloat(a.value || 0).toFixed(2) + '</td>';
                entriesBody.appendChild(row);
            });
            
            // Exits table
            const exitsBody = document.getElementById('exitsTable');
            exitsBody.innerHTML = '';
            exits.forEach(e => {
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + formatDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.category + '</td><td>R$ ' + parseFloat(e.value).toFixed(2) + '</td><td><button class="btn btn-danger" onclick="deleteExpense(\'' + e.id + '\')">Excluir</button></td>';
                exitsBody.appendChild(row);
            });
        }

        function deleteExpense(id) {
            if (!confirm('Excluir esta despesa?')) return;
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('asm_expenses', JSON.stringify(expenses));
            renderCashFlow();
        }

        // RELAT√ìRIOS GERAIS
        function renderReports() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;
            
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            
            const monthAppts = appointments.filter(a => {
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const revenue = monthAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('reportSessions').textContent = monthAppts.length;
            document.getElementById('reportRevenue').textContent = 'R$ ' + revenue.toFixed(2);
            
            // Group by patient
            const stats = {};
            monthAppts.forEach(a => {
                if (!stats[a.patientId]) stats[a.patientId] = { count: 0, total: 0 };
                stats[a.patientId].count++;
                if (a.paid) stats[a.patientId].total += parseFloat(a.value || 0);
            });
            
            const tbody = document.getElementById('reportTable');
            tbody.innerHTML = '';
            
            for (let pid in stats) {
                const p = patients.find(x => x.id === pid);
                const s = stats[pid];
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + (p ? p.name : '-') + '</td><td>' + s.count + '</td><td>R$ ' + s.total.toFixed(2) + '</td>';
                tbody.appendChild(row);
            }
        }

        // EXPORTAR EXCEL
        function exportToExcel() {
            let csv = 'Paciente;Data;Servico;Valor;Status\n';
            
            appointments.forEach(a => {
                const p = patients.find(x => x.id === a.patientId);
                csv += (p ? p.name : '-') + ';' + formatDate(a.date) + ';' + a.type + ';' + parseFloat(a.value || 0).toFixed(2) + ';' + (a.paid ? 'Pago' : 'Pendente') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ASM_Financeiro_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        // UTILIT√ÅRIOS
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            return parts[2] + '/' + parts[1] + '/' + parts[0];
        }

        function loadPatientSelect() {
            const select = document.getElementById('apptPatient');
            select.innerHTML = '<option value="">Selecione...</option>';
            patients.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal').forEach(m => {
            m.onclick = function(e) {
                if (e.target === this) this.classList.remove('active');
            };
        });
    </script>
</body>
</html>