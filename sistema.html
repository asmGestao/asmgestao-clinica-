<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM Gest√£o Cl√≠nica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
        }
        
        .header {
            background: #264653;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: #2a9d8f;
            flex-wrap: wrap;
        }
        
        .nav button {
            padding: 10px 20px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .nav button:hover, .nav button.active {
            background: white;
            color: #264653;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            padding-bottom: 100px;
        }
        
        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section.active { display: block; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn-primary { background: #2a9d8f; color: white; }
        .btn-success { background: #52b788; color: white; }
        .btn-danger { background: #e76f51; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-warning { background: #f4a261; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-gold { background: #d4af37; color: #264653; font-weight: bold; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .card:hover {
            border-color: #2a9d8f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #264653;
            color: white;
        }
        
        .calendar-day {
            background: #f8f9fa;
            min-height: 100px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .calendar-day:hover { background: #e9ecef; }
        
        .appointment {
            background: #2a9d8f;
            color: white;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .appointment.cancelled {
            background: #adb5bd;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .appointment-actions {
            display: flex;
            gap: 3px;
        }
        
        .appointment-actions button {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th { background: #f8f9fa; font-weight: bold; }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }
        
        .summary-card.green { background: #52b788; }
        .summary-card.red { background: #e76f51; }
        .summary-card.blue { background: #264653; }
        .summary-card.orange { background: #f4a261; }
        
        .summary-card h3 { font-size: 32px; margin-bottom: 5px; }
        .summary-card p { font-size: 14px; opacity: 0.9; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        
        .tab.active {
            color: #2a9d8f;
            border-bottom: 2px solid #2a9d8f;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .report-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .settings-box {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #264653;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            background: #264653;
            color: white;
            margin-top: 40px;
            font-size: 12px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        
        .footer p { margin: 5px 0; opacity: 0.8; }
        
        .checkbox-custom {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .selected-row {
            background: #e8f5e9 !important;
        }
        
        .charge-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        
        .pix-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
        }
        
        .evolution-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #2a9d8f;
            position: relative;
        }
        
        .evolution-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        
        .report-preview {
            background: white;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin: 20px 0;
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        
        .report-header {
            text-align: center;
            border-bottom: 2px solid #264653;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        
        .report-section {
            margin: 20px 0;
        }
        
        .report-section h4 {
            color: #264653;
            margin-bottom: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        
        @media print {
            .no-print { display: none !important; }
            .report-preview { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè• ASM Gest√£o Cl√≠nica</h1>
        <p id="headerSubtitle">Sistema de Gest√£o para Fisioterapeutas</p>
    </div>
    
    <div class="nav">
        <button class="active" onclick="showSection('agenda')">üìÖ Agenda</button>
        <button onclick="showSection('pacientes')">üë• Pacientes</button>
        <button onclick="showSection('financeiro')">üí∞ Financeiro</button>
        <button onclick="showSection('fluxo')">üìä Fluxo de Caixa</button>
        <button onclick="showSection('relatorios')">üìà Relat√≥rios</button>
        <button onclick="showSection('configuracoes')">‚öôÔ∏è Configura√ß√µes</button>
    </div>
    
    <div class="container">
        <!-- CONFIGURA√á√ïES -->
        <div id="configuracoes" class="section">
            <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
            <p style="margin-bottom: 20px; color: #666;">Configure aqui os dados do profissional que aparecer√£o nos relat√≥rios e mensagens.</p>
            
            <div class="settings-box">
                <div class="form-group">
                    <label>Nome do Profissional *</label>
                    <input type="text" id="configName" placeholder="Ex: Dra. Andresa Augusto">
                </div>
                
                <div class="form-group">
                    <label>N√∫mero do CREFITO *</label>
                    <input type="text" id="configCrefito" placeholder="Ex: 123456-F">
                </div>
                
                <div class="form-group">
                    <label>Nome da Cl√≠nica (opcional)</label>
                    <input type="text" id="configClinic" placeholder="Ex: ASM Fisioterapia">
                </div>
                
                <div class="form-group">
                    <label>Chave PIX para cobran√ßas</label>
                    <input type="text" id="configPix" placeholder="Ex: CPF, CNPJ, e-mail, telefone ou chave aleat√≥ria">
                    <small style="color: #666;">Esta chave ser√° enviada nas mensagens de cobran√ßa autom√°ticas</small>
                </div>
                
                <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar Configura√ß√µes</button>
            </div>
        </div>
        
        <!-- AGENDA -->
        <div id="agenda" class="section active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Agenda de Atendimentos</h2>
                <button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê Anterior</button>
                <h3 id="currentMonth"></h3>
                <button class="btn btn-primary" onclick="changeMonth(1)">Pr√≥ximo ‚Üí</button>
            </div>
            
            <div class="calendar" id="calendar"></div>
        </div>
        
        <!-- PACIENTES -->
        <div id="pacientes" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Cadastro de Pacientes</h2>
                <button class="btn btn-primary" onclick="openPatientModal()">+ Novo Paciente</button>
            </div>
            
            <input type="text" style="width: 100%; padding: 10px; margin-bottom: 20px;" placeholder="Buscar paciente..." oninput="searchPatients(this.value)">
            
            <div class="grid" id="patientsList"></div>
        </div>
        
        <!-- FINANCEIRO -->
        <div id="financeiro" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Controle Financeiro</h2>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar Excel</button>
            </div>
            
            <div class="summary-cards">
                <div class="summary-card green">
                    <h3 id="totalReceived">R$ 0,00</h3>
                    <p>Total Recebido</p>
                </div>
                <div class="summary-card red">
                    <h3 id="totalPending">R$ 0,00</h3>
                    <p>Total a Receber</p>
                </div>
                <div class="summary-card blue">
                    <h3 id="totalSessions">0</h3>
                    <p>Total de Sess√µes</p>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>Data</th>
                        <th>Servi√ßo</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="financialTable"></tbody>
            </table>
        </div>
        
        <!-- FLUXO DE CAIXA -->
        <div id="fluxo" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Fluxo de Caixa</h2>
                <button class="btn btn-primary" onclick="openExpenseModal()">+ Nova Despesa</button>
            </div>
            
            <div class="form-group">
                <label>M√™s/Ano</label>
                <input type="month" id="cashFlowMonth" onchange="renderCashFlow()">
            </div>
            
            <div class="summary-cards">
                <div class="summary-card green">
                    <h3 id="cfEntries">R$ 0,00</h3>
                    <p>Entradas</p>
                </div>
                <div class="summary-card red">
                    <h3 id="cfExits">R$ 0,00</h3>
                    <p>Sa√≠das</p>
                </div>
                <div class="summary-card blue">
                    <h3 id="cfBalance">R$ 0,00</h3>
                    <p>Saldo</p>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showCashFlowTab('entries')">Entradas</button>
                <button class="tab" onclick="showCashFlowTab('exits')">Despesas</button>
            </div>
            
            <div id="cfEntriesTab" class="tab-content active">
                <table>
                    <thead>
                        <tr><th>Data</th><th>Paciente</th><th>Servi√ßo</th><th>Valor</th></tr>
                    </thead>
                    <tbody id="entriesTable"></tbody>
                </table>
            </div>
            
            <div id="cfExitsTab" class="tab-content">
                <table>
                    <thead>
                        <tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr>
                    </thead>
                    <tbody id="exitsTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- RELAT√ìRIOS PRINCIPAL FUNCIONAL -->
        <div id="relatorios" class="section">
            <h2>Relat√≥rios de Gest√£o</h2>
            
            <div class="form-group">
                <label>M√™s/Ano</label>
                <input type="month" id="reportMonth" onchange="renderReports()">
            </div>
            
            <div class="summary-cards">
                <div class="summary-card blue">
                    <h3 id="reportSessions">0</h3>
                    <p>Atendimentos</p>
                </div>
                <div class="summary-card green">
                    <h3 id="reportRevenue">R$ 0,00</h3>
                    <p>Faturamento</p>
                </div>
            </div>
            
            <div id="mainReportActions" style="display: none; margin: 20px 0;">
                <button class="btn btn-gold" onclick="generateMainPDF()">üìÑ Gerar PDF do M√™s</button>
                <button class="btn btn-whatsapp" onclick="sendMainReportWhatsApp()">üì± Enviar Resumo WhatsApp</button>
            </div>
            
            <h3 style="margin-top: 30px;">Pacientes Atendidos</h3>
            <table>
                <thead>
                    <tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr>
                </thead>
                <tbody id="reportTable"></tbody>
            </table>
            
            <div id="mainReportPreview" style="display: none; margin-top: 30px;">
                <h4>Pr√©-visualiza√ß√£o do Relat√≥rio</h4>
                <div class="report-preview" id="mainReportContent"></div>
            </div>
        </div>
    </div>
    
    <!-- MODAL AGENDAMENTO -->
    <div class="modal" id="appointmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agendamento</h3>
                <button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Paciente *</label>
                <select id="apptPatient"></select>
            </div>
            
            <div class="form-group">
                <label>Data *</label>
                <input type="date" id="apptDate">
            </div>
            
            <div class="form-group">
                <label>Hor√°rio *</label>
                <input type="time" id="apptTime">
            </div>
            
            <div class="form-group">
                <label>Tipo</label>
                <select id="apptType">
                    <option value="normal">Normal</option>
                    <option value="laser">Com Laser</option>
                    <option value="avaliacao">Avalia√ß√£o</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Valor (R$)</label>
                <input type="number" id="apptValue" step="0.01">
            </div>
            
            <div class="form-group">
                <label>Observa√ß√µes</label>
                <textarea id="apptNotes" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-whatsapp" id="btnWhatsAppt" onclick="sendAppointmentWhatsApp()" style="display: none;">üì± WhatsApp</button>
                <button class="btn btn-warning" id="btnToggleCancel" onclick="toggleCancelAppointment()" style="display: none;">‚ùå Cancelar</button>
                <button class="btn btn-primary" onclick="saveAppointment()" style="margin-left: auto;">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PACIENTE -->
    <div class="modal" id="patientModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="patientModalTitle">Novo Paciente</h3>
                <button class="close-btn" onclick="closeModal('patientModal')">&times;</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showPatientTab('info')">Informa√ß√µes</button>
                <button class="tab" onclick="showPatientTab('financeiro')">Financeiro</button>
                <button class="tab" onclick="showPatientTab('evolucao')">Evolu√ß√£o</button>
                <button class="tab" onclick="showPatientTab('relatorio')">Relat√≥rio Mensal</button>
            </div>
            
            <!-- ABA INFO -->
            <div id="tabInfo" class="tab-content active">
                <input type="hidden" id="patientId">
                
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="patientName">
                </div>
                
                <div class="form-group">
                    <label>Telefone *</label>
                    <input type="tel" id="patientPhone" placeholder="(00) 00000-0000">
                </div>
                
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="patientEmail">
                </div>
                
                <div class="form-group">
                    <label>Valor Padr√£o (R$)</label>
                    <input type="number" id="patientValue" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Queixa Principal</label>
                    <textarea id="patientComplaint" rows="3"></textarea>
                </div>
            </div>
            
            <!-- ABA FINANCEIRO COM COBRAN√áA -->
            <div id="tabFinanceiro" class="tab-content">
                <div class="summary-cards">
                    <div class="summary-card green">
                        <h3 id="patientPaid">R$ 0,00</h3>
                        <p>Pago</p>
                    </div>
                    <div class="summary-card red">
                        <h3 id="patientPending">R$ 0,00</h3>
                        <p>Pendente</p>
                    </div>
                </div>
                
                <div class="charge-box" id="chargeBox" style="display: none;">
                    <h4>üì≤ Cobran√ßa Selecionada</h4>
                    <p>Sess√µes selecionadas: <strong id="selectedCount">0</strong></p>
                    <p>Total a cobrar: <strong id="selectedTotal">R$ 0,00</strong></p>
                    <button class="btn btn-whatsapp" onclick="sendChargeWhatsApp()">üì± Enviar Cobran√ßa por WhatsApp</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>Data</th>
                            <th>Servi√ßo</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="patientFinanceTable"></tbody>
                </table>
            </div>
            
            <!-- ABA EVOLU√á√ÉO COM EXPORTA√á√ÉO -->
            <div id="tabEvolucao" class="tab-content">
                <div class="form-group">
                    <label>Nova Evolu√ß√£o</label>
                    <textarea id="newEvolution" rows="4" placeholder="Descreva a evolu√ß√£o do paciente..."></textarea>
                    <button class="btn btn-primary" onclick="addEvolution()" style="margin-top: 10px;">üíæ Salvar Evolu√ß√£o</button>
                </div>
                
                <div id="evolutionsList" style="margin-top: 20px;"></div>
            </div>
            
            <!-- ABA RELAT√ìRIO MELHORADA COM PDF -->
            <div id="tabRelatorio" class="tab-content">
                <div class="form-group">
                    <label>M√™s/Ano do Relat√≥rio</label>
                    <input type="month" id="reportMonthPatient">
                </div>
                
                <button class="btn btn-primary" onclick="generatePatientReport()">üìã Gerar Relat√≥rio Mensal</button>
                
                <div id="reportContainer" style="display: none; margin-top: 20px;">
                    <div class="report-preview" id="reportContent"></div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn btn-gold" onclick="generatePatientPDF()">üìÑ Gerar PDF</button>
                        <button class="btn btn-whatsapp" onclick="sendReportWhatsApp()">üì± Enviar WhatsApp</button>
                        <button class="btn btn-secondary" onclick="copyReport()">üìã Copiar Texto</button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()">Excluir</button>
                <button class="btn btn-primary" onclick="savePatient()">Salvar Paciente</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DESPESA -->
    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nova Despesa</h3>
                <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Data *</label>
                <input type="date" id="expenseDate">
            </div>
            
            <div class="form-group">
                <label>Descri√ß√£o *</label>
                <input type="text" id="expenseDesc" placeholder="Ex: Aluguel, Material...">
            </div>
            
            <div class="form-group">
                <label>Categoria</label>
                <select id="expenseCategory">
                    <option value="material">Material/Equipamento</option>
                    <option value="aluguel">Aluguel</option>
                    <option value="servicos">Servi√ßos</option>
                    <option value="outros">Outros</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Valor (R$) *</label>
                <input type="number" id="expenseValue" step="0.01">
            </div>
            
            <button class="btn btn-primary" onclick="saveExpense()">Salvar Despesa</button>
        </div>
    </div>

    <div class="footer">
        <p><strong>ASM Gest√£o Cl√≠nica</strong></p>
        <p>¬© 2024 Dra. Andresa Augusto - Todos os direitos reservados</p>
        <p>Proibida a reprodu√ß√£o total ou parcial sem autoriza√ß√£o expressa</p>
        <p>Desenvolvido exclusivamente para uso profissional autorizado</p>
    </div>

    <script>
        // CONFIGURA√á√ïES GLOBAIS
        let config = JSON.parse(localStorage.getItem('asm_config')) || {
            professionalName: '',
            crefito: '',
            clinicName: 'ASM Fisioterapia',
            pixKey: ''
        };
        
        // DADOS
        let patients = JSON.parse(localStorage.getItem('asm_patients')) || [];
        let appointments = JSON.parse(localStorage.getItem('asm_appointments')) || [];
        let evolutions = JSON.parse(localStorage.getItem('asm_evolutions')) || [];
        let expenses = JSON.parse(localStorage.getItem('asm_expenses')) || [];
        
        let currentDate = new Date();
        let currentPatientId = null;
        let currentApptId = null;
        let currentReport = '';
        let selectedCharges = new Set();
        let currentMainReport = '';

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            renderCalendar();
            renderPatients();
            updateFinancialSummary();
            loadPatientSelect();
            
            const today = new Date().toISOString().slice(0, 7);
            document.getElementById('cashFlowMonth').value = today;
            document.getElementById('reportMonth').value = today;
        });

        // CONFIGURA√á√ïES
        function loadConfig() {
            document.getElementById('configName').value = config.professionalName;
            document.getElementById('configCrefito').value = config.crefito;
            document.getElementById('configClinic').value = config.clinicName;
            document.getElementById('configPix').value = config.pixKey || '';
            
            updateHeader();
        }
        
        function saveConfig() {
            config.professionalName = document.getElementById('configName').value.trim();
            config.crefito = document.getElementById('configCrefito').value.trim();
            config.clinicName = document.getElementById('configClinic').value.trim() || 'ASM Fisioterapia';
            config.pixKey = document.getElementById('configPix').value.trim();
            
            if (!config.professionalName || !config.crefito) {
                alert('Preencha o nome do profissional e o CREFITO!');
                return;
            }
            
            localStorage.setItem('asm_config', JSON.stringify(config));
            updateHeader();
            alert('Configura√ß√µes salvas com sucesso!');
        }
        
        function updateHeader() {
            const subtitle = document.getElementById('headerSubtitle');
            if (config.professionalName) {
                subtitle.textContent = config.professionalName + ' - CREFITO ' + config.crefito;
            } else {
                subtitle.textContent = 'Configure seus dados em "Configura√ß√µes"';
            }
        }
        
        function getProfessionalSignature() {
            const name = config.professionalName || 'Profissional';
            const crefito = config.crefito ? 'CREFITO ' + config.crefito : '';
            const clinic = config.clinicName || 'ASM Fisioterapia';
            const pix = config.pixKey || '';
            return { name, crefito, clinic, pix };
        }

        // NAVEGA√á√ÉO
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            if (section === 'financeiro') renderFinancialTable();
            if (section === 'fluxo') renderCashFlow();
            if (section === 'relatorios') renderReports();
        }

        // CALEND√ÅRIO
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            days.forEach(day => {
                const div = document.createElement('div');
                div.className = 'calendar-header';
                div.textContent = day;
                calendar.appendChild(div);
            });
            
            for (let i = 0; i < firstDay; i++) {
                calendar.appendChild(document.createElement('div'));
            }
            
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerHTML = '<strong>' + day + '</strong>';
                
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    div.style.background = '#2a9d8f';
                    div.style.color = 'white';
                }
                
                const dayAppointments = appointments.filter(a => {
                    const parts = a.date.split('-');
                    const y = parseInt(parts[0]);
                    const m = parseInt(parts[1]);
                    const d = parseInt(parts[2]);
                    return y === year && (m - 1) === month && d === day;
                });
                
                dayAppointments.forEach(appt => {
                    const patient = patients.find(p => p.id === appt.patientId);
                    const apptDiv = document.createElement('div');
                    apptDiv.className = 'appointment' + (appt.cancelled ? ' cancelled' : '');
                    apptDiv.innerHTML = '<span>' + appt.time + ' ' + (patient ? patient.name.split(' ')[0] : '') + '</span>';
                    
                    const actions = document.createElement('div');
                    actions.className = 'appointment-actions';
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '‚úé';
                    editBtn.title = 'Editar';
                    editBtn.onclick = function(e) {
                        e.stopPropagation();
                        editAppointment(appt.id);
                    };
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = appt.cancelled ? '‚Ü©' : '‚úï';
                    cancelBtn.title = appt.cancelled ? 'Reativar' : 'Cancelar';
                    cancelBtn.onclick = function(e) {
                        e.stopPropagation();
                        toggleCancelAppointmentDirect(appt.id);
                    };
                    
                    actions.appendChild(editBtn);
                    actions.appendChild(cancelBtn);
                    apptDiv.appendChild(actions);
                    
                    div.appendChild(apptDiv);
                });
                
                div.onclick = function() {
                    openAppointmentModal(year, month, day);
                };
                calendar.appendChild(div);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // PACIENTES
        function renderPatients() {
            const list = document.getElementById('patientsList');
            list.innerHTML = '';
            
            patients.forEach(p => {
                const patientAppts = appointments.filter(a => a.patientId === p.id && !a.cancelled);
                const pending = patientAppts.filter(a => !a.paid).length;
                
                const card = document.createElement('div');
                card.className = 'card';
                let html = '<h3>' + p.name + '</h3>';
                html += '<p>üì± ' + p.phone + '</p>';
                html += '<p>üí∞ R$ ' + parseFloat(p.defaultValue || 0).toFixed(2) + '</p>';
                if (pending > 0) {
                    html += '<p style="color: #e76f51;">‚ö†Ô∏è ' + pending + ' pendente(s)</p>';
                }
                card.innerHTML = html;
                card.onclick = function() {
                    openPatientModal(p.id);
                };
                list.appendChild(card);
            });
        }

        function searchPatients(term) {
            const cards = document.querySelectorAll('#patientsList .card');
            cards.forEach(card => {
                const name = card.querySelector('h3').textContent.toLowerCase();
                card.style.display = name.includes(term.toLowerCase()) ? 'block' : 'none';
            });
        }

        function openPatientModal(patientId) {
            currentPatientId = patientId;
            selectedCharges.clear();
            const modal = document.getElementById('patientModal');
            
            // Reset
            document.getElementById('patientId').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientEmail').value = '';
            document.getElementById('patientValue').value = '';
            document.getElementById('patientComplaint').value = '';
            
            showPatientTab('info');
            
            if (patientId) {
                const p = patients.find(x => x.id === patientId);
                document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
                document.getElementById('patientId').value = p.id;
                document.getElementById('patientName').value = p.name;
                document.getElementById('patientPhone').value = p.phone;
                document.getElementById('patientEmail').value = p.email || '';
                document.getElementById('patientValue').value = p.defaultValue || '';
                document.getElementById('patientComplaint').value = p.complaint || '';
                document.getElementById('btnDeletePatient').style.display = 'block';
                
                renderPatientFinance();
                renderEvolutions();
            } else {
                document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
                document.getElementById('btnDeletePatient').style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function savePatient() {
            const id = document.getElementById('patientId').value;
            const data = {
                id: id || Date.now().toString(),
                name: document.getElementById('patientName').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                defaultValue: document.getElementById('patientValue').value,
                complaint: document.getElementById('patientComplaint').value
            };
            
            if (!data.name || !data.phone) {
                alert('Preencha nome e telefone!');
                return;
            }
            
            if (id) {
                const idx = patients.findIndex(p => p.id === id);
                patients[idx] = data;
            } else {
                patients.push(data);
            }
            
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            closeModal('patientModal');
            renderPatients();
            loadPatientSelect();
        }

        function deletePatient() {
            if (!confirm('Excluir paciente e todos os dados?')) return;
            
            patients = patients.filter(p => p.id !== currentPatientId);
            appointments = appointments.filter(a => a.patientId !== currentPatientId);
            evolutions = evolutions.filter(e => e.patientId !== currentPatientId);
            
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            
            closeModal('patientModal');
            renderPatients();
            renderCalendar();
            updateFinancialSummary();
        }

        function showPatientTab(tab) {
            document.querySelectorAll('#patientModal .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            if (tab === 'financeiro') renderPatientFinance();
            if (tab === 'evolucao') renderEvolutions();
        }

        // FINANCEIRO DO PACIENTE COM COBRAN√áA
        function renderPatientFinance() {
            const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled);
            const paid = patientAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const pending = patientAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('patientPaid').textContent = 'R$ ' + paid.toFixed(2);
            document.getElementById('patientPending').textContent = 'R$ ' + pending.toFixed(2);
            
            const tbody = document.getElementById('patientFinanceTable');
            tbody.innerHTML = '';
            
            const pendingAppts = patientAppts.filter(a => !a.paid).sort((a, b) => new Date(a.date) - new Date(b.date));
            const paidAppts = patientAppts.filter(a => a.paid).sort((a, b) => new Date(b.date) - new Date(a.date));
            const sortedAppts = [...pendingAppts, ...paidAppts];
            
            sortedAppts.forEach(appt => {
                const row = document.createElement('tr');
                if (selectedCharges.has(appt.id)) row.classList.add('selected-row');
                
                const isPending = !appt.paid;
                
                let html = '<td>';
                if (isPending) {
                    html += '<input type="checkbox" class="checkbox-custom" ' + (selectedCharges.has(appt.id) ? 'checked' : '') + ' onchange="toggleChargeSelection(\'' + appt.id + '\', ' + appt.value + ')">';
                } else {
                    html += '‚úì';
                }
                html += '</td>';
                
                html += '<td>' + formatDate(appt.date) + '</td>';
                html += '<td>' + appt.type + '</td>';
                html += '<td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td>';
                html += '<td>' + (appt.paid ? '<span class="badge badge-success">Pago</span>' : '<span class="badge badge-warning">Pendente</span>') + '</td>';
                html += '<td><button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="togglePayment(\'' + appt.id + '\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                
                row.innerHTML = html;
                tbody.appendChild(row);
            });
            
            updateChargeBox();
        }

        function toggleChargeSelection(apptId, value) {
            if (selectedCharges.has(apptId)) {
                selectedCharges.delete(apptId);
            } else {
                selectedCharges.add(apptId);
            }
            renderPatientFinance();
        }

        function toggleSelectAll() {
            const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && !a.paid);
            const allSelected = patientAppts.every(a => selectedCharges.has(a.id));
            
            if (allSelected) {
                patientAppts.forEach(a => selectedCharges.delete(a.id));
            } else {
                patientAppts.forEach(a => selectedCharges.add(a.id));
            }
            
            document.getElementById('selectAll').checked = !allSelected;
            renderPatientFinance();
        }

        function updateChargeBox() {
            const box = document.getElementById('chargeBox');
            if (selectedCharges.size === 0) {
                box.style.display = 'none';
                return;
            }
            
            box.style.display = 'block';
            document.getElementById('selectedCount').textContent = selectedCharges.size;
            
            let total = 0;
            selectedCharges.forEach(id => {
                const appt = appointments.find(a => a.id === id);
                if (appt) total += parseFloat(appt.value || 0);
            });
            
            document.getElementById('selectedTotal').textContent = 'R$ ' + total.toFixed(2);
        }

        function sendChargeWhatsApp() {
            if (selectedCharges.size === 0) return;
            
            const patient = patients.find(p => p.id === currentPatientId);
            const sig = getProfessionalSignature();
            
            let total = 0;
            let sessionsList = [];
            
            selectedCharges.forEach(id => {
                const appt = appointments.find(a => a.id === id);
                if (appt) {
                    total += parseFloat(appt.value || 0);
                    sessionsList.push(formatDate(appt.date) + ' - R$ ' + parseFloat(appt.value || 0).toFixed(2));
                }
            });
            
            let msg = 'Ol√° ' + patient.name.split(' ')[0] + ', tudo bem? üòä\n\n';
            msg += 'Segue a rela√ß√£o das sess√µes em aberto na ' + sig.clinic + ':\n\n';
            
            sessionsList.forEach((session, idx) => {
                msg += (idx + 1) + '. ' + session + '\n';
            });
            
            msg += '\nüí∞ *Total a pagar: R$ ' + total.toFixed(2) + '*\n\n';
            
            if (sig.pix) {
                msg += 'üí≥ Para pagamento via PIX, utilize a chave:\n';
                msg += '*' + sig.pix + '*\n\n';
                msg += 'Ou envie o comprovante para este n√∫mero assim que realizar o pagamento.\n\n';
            }
            
            msg += 'Qualquer d√∫vida estou √† disposi√ß√£o!\n';
            if (sig.name) msg += '\nAtenciosamente,\n' + sig.name;
            
            window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }

        // AGENDAMENTOS
        function openAppointmentModal(year, month, day) {
            currentApptId = null;
            document.getElementById('apptPatient').value = '';
            document.getElementById('apptTime').value = '';
            document.getElementById('apptValue').value = '';
            document.getElementById('apptNotes').value = '';
            document.getElementById('btnWhatsAppt').style.display = 'none';
            document.getElementById('btnToggleCancel').style.display = 'none';
            
            if (year !== undefined) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                document.getElementById('apptDate').value = dateStr;
            } else {
                document.getElementById('apptDate').value = new Date().toISOString().split('T')[0];
            }
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function editAppointment(id) {
            const appt = appointments.find(a => a.id === id);
            currentApptId = id;
            
            document.getElementById('apptPatient').value = appt.patientId;
            document.getElementById('apptDate').value = appt.date;
            document.getElementById('apptTime').value = appt.time;
            document.getElementById('apptType').value = appt.type;
            document.getElementById('apptValue').value = appt.value;
            document.getElementById('apptNotes').value = appt.notes || '';
            document.getElementById('btnWhatsAppt').style.display = 'inline-block';
            document.getElementById('btnToggleCancel').style.display = 'inline-block';
            
            const btnCancel = document.getElementById('btnToggleCancel');
            if (appt.cancelled) {
                btnCancel.textContent = '‚Ü© Reativar Agendamento';
                btnCancel.className = 'btn btn-success';
            } else {
                btnCancel.textContent = '‚ùå Cancelar Agendamento';
                btnCancel.className = 'btn btn-warning';
            }
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function saveAppointment() {
            const patientId = document.getElementById('apptPatient').value;
            if (!patientId) {
                alert('Selecione um paciente!');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            const data = {
                id: currentApptId || Date.now().toString(),
                patientId: patientId,
                date: document.getElementById('apptDate').value,
                time: document.getElementById('apptTime').value,
                type: document.getElementById('apptType').value,
                value: document.getElementById('apptValue').value || patient.defaultValue || 0,
                notes: document.getElementById('apptNotes').value,
                paid: currentApptId ? appointments.find(a => a.id === currentApptId).paid : false,
                cancelled: currentApptId ? appointments.find(a => a.id === currentApptId).cancelled : false
            };
            
            if (currentApptId) {
                const idx = appointments.findIndex(a => a.id === currentApptId);
                appointments[idx] = data;
            } else {
                appointments.push(data);
            }
            
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            closeModal('appointmentModal');
            renderCalendar();
            updateFinancialSummary();
        }

        function toggleCancelAppointment() {
            if (!currentApptId) return;
            toggleCancelAppointmentDirect(currentApptId);
            closeModal('appointmentModal');
        }
        
        function toggleCancelAppointmentDirect(id) {
            const appt = appointments.find(a => a.id === id);
            appt.cancelled = !appt.cancelled;
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            renderCalendar();
            updateFinancialSummary();
        }

        function sendAppointmentWhatsApp() {
            if (!currentApptId) return;
            
            const appt = appointments.find(a => a.id === currentApptId);
            const patient = patients.find(p => p.id === appt.patientId);
            const sig = getProfessionalSignature();
            
            const clinicName = sig.clinic;
            const profName = sig.name;
            const crefito = sig.crefito;
            
            let msg = 'Ol√° ' + patient.name + ', tudo bem? üòä\n\n';
            msg += 'Passando para confirmar seu agendamento:\n\n';
            msg += 'üìÖ Data: ' + formatDate(appt.date) + '\n';
            msg += '‚è∞ Hor√°rio: ' + appt.time + '\n';
            msg += 'üè• Local: ' + clinicName + '\n\n';
            
            if (!appt.cancelled) {
                msg += 'Estamos te aguardando! ' + (profName ? '\nAtenciosamente, ' + profName : '') + '\n';
                if (crefito) msg += crefito + '\n';
            } else {
                msg += '‚ö†Ô∏è ATEN√á√ÉO: Este agendamento foi CANCELADO.\n';
            }
            
            window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }

        // FINANCEIRO GERAL
        function renderFinancialTable() {
            const tbody = document.getElementById('financialTable');
            tbody.innerHTML = '';
            
            const sorted = appointments.filter(a => !a.cancelled).slice().sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(appt => {
                const patient = patients.find(p => p.id === appt.patientId);
                const row = document.createElement('tr');
                
                let html = '<td>' + (patient ? patient.name : '-') + '</td>';
                html += '<td>' + formatDate(appt.date) + '</td>';
                html += '<td>' + (appt.type === 'laser' ? 'Laser' : 'Normal') + '</td>';
                html += '<td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td>';
                html += '<td>' + (appt.paid ? '‚úÖ Pago' : '‚è≥ Pendente') + '</td>';
                html += '<td><button class="btn btn-primary" onclick="togglePayment(\'' + appt.id + '\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        function updateFinancialSummary() {
            const activeAppts = appointments.filter(a => !a.cancelled);
            const received = activeAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const pending = activeAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('totalReceived').textContent = 'R$ ' + received.toFixed(2);
            document.getElementById('totalPending').textContent = 'R$ ' + pending.toFixed(2);
            document.getElementById('totalSessions').textContent = activeAppts.length;
        }

        function togglePayment(id) {
            const appt = appointments.find(a => a.id === id);
            appt.paid = !appt.paid;
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            
            renderFinancialTable();
            updateFinancialSummary();
            renderCalendar();
            if (currentPatientId) renderPatientFinance();
        }

        // EVOLU√á√ïES COM EXPORTA√á√ÉO
        function renderEvolutions() {
            const list = document.getElementById('evolutionsList');
            list.innerHTML = '';
            
            const patientEvos = evolutions.filter(e => e.patientId === currentPatientId)
                .sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
            
            patientEvos.forEach(evo => {
                const div = document.createElement('div');
                div.className = 'evolution-item';
                
                let html = '<small style="color: #666; display: block; margin-bottom: 5px;">üìÖ ' + formatDate(evo.date) + ' √†s ' + evo.time + '</small>';
                html += '<p style="margin: 0; white-space: pre-wrap;">' + evo.text + '</p>';
                
                html += '<div class="evolution-actions">';
                html += '<button class="btn btn-whatsapp" style="padding: 5px 10px; font-size: 12px;" onclick="sendEvolutionWhatsApp(\'' + evo.id + '\')">üì± Enviar WhatsApp</button>';
                html += '<button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="copyEvolution(\'' + evo.id + '\')">üìã Copiar</button>';
                html += '</div>';
                
                div.innerHTML = html;
                list.appendChild(div);
            });
        }

        function addEvolution() {
            const text = document.getElementById('newEvolution').value;
            if (!text.trim()) return;
            
            const now = new Date();
            const evo = {
                id: Date.now().toString(),
                patientId: currentPatientId,
                date: now.toISOString().split('T')[0],
                time: now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                text: text
            };
            
            evolutions.push(evo);
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            
            document.getElementById('newEvolution').value = '';
            renderEvolutions();
        }

        function sendEvolutionWhatsApp(evoId) {
            const evo = evolutions.find(e => e.id === evoId);
            const patient = patients.find(p => p.id === currentPatientId);
            const sig = getProfessionalSignature();
            
            let msg = 'Ol√° ' + patient.name.split(' ')[0] + ', tudo bem? üòä\n\n';
            msg += 'Segue a evolu√ß√£o da sua sess√£o do dia ' + formatDate(evo.date) + ':\n\n';
            msg += evo.text + '\n\n';
            
            if (sig.name) {
                msg += 'Atenciosamente,\n' + sig.name + '\n';
                if (sig.crefito) msg += sig.crefito + '\n';
            }
            msg += sig.clinic;
            
            window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }

        function copyEvolution(evoId) {
            const evo = evolutions.find(e => e.id === evoId);
            navigator.clipboard.writeText(evo.text).then(() => alert('Evolu√ß√£o copiada!'));
        }

        // RELAT√ìRIO DO PACIENTE MELHORADO
        function generatePatientReport() {
            const month = document.getElementById('reportMonthPatient').value;
            if (!month) {
                alert('Selecione o m√™s!');
                return;
            }
            
            const sig = getProfessionalSignature();
            
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            const patient = patients.find(p => p.id === currentPatientId);
            
            const monthEvos = evolutions.filter(e => {
                if (e.patientId !== currentPatientId) return false;
                const ep = e.date.split('-');
                return parseInt(ep[0]) === year && parseInt(ep[1]) === mon;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const monthAppts = appointments.filter(a => {
                if (a.patientId !== currentPatientId || a.cancelled) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            // Criar relat√≥rio formatado em HTML
            let reportHTML = '<div class="report-header">';
            reportHTML += '<h2>' + sig.clinic + '</h2>';
            if (sig.name) reportHTML += '<p><strong>' + sig.name + '</strong></p>';
            if (sig.crefito) reportHTML += '<p>' + sig.crefito + '</p>';
            reportHTML += '</div>';
            
            reportHTML += '<div class="report-section">';
            reportHTML += '<h4>üìã DADOS DO PACIENTE</h4>';
            reportHTML += '<p><strong>Nome:</strong> ' + patient.name + '</p>';
            reportHTML += '<p><strong>Per√≠odo:</strong> ' + monthName + '</p>';
            reportHTML += '</div>';
            
            reportHTML += '<div class="report-section">';
            reportHTML += '<h4>üìÖ SESS√ïES REALIZADAS (' + monthAppts.length + ')</h4>';
            if (monthAppts.length > 0) {
                reportHTML += '<ul>';
                monthAppts.forEach(a => {
                    reportHTML += '<li>' + formatDate(a.date) + ' √†s ' + a.time + ' - ' + a.type + '</li>';
                });
                reportHTML += '</ul>';
            } else {
                reportHTML += '<p>Nenhuma sess√£o registrada neste per√≠odo.</p>';
            }
            reportHTML += '</div>';
            
            reportHTML += '<div class="report-section">';
            reportHTML += '<h4>üìä EVOLU√á√ÉO CL√çNICA</h4>';
            
            if (monthEvos.length === 0) {
                reportHTML += '<p>Nenhuma evolu√ß√£o registrada neste per√≠odo.</p>';
            } else {
                monthEvos.forEach((evo, i) => {
                    reportHTML += '<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">';
                    reportHTML += '<strong>Sess√£o ' + (i + 1) + ' - ' + formatDate(evo.date) + '</strong>';
                    reportHTML += '<p style="margin-top: 5px; white-space: pre-wrap;">' + evo.text + '</p>';
                    reportHTML += '</div>';
                });
            }
            reportHTML += '</div>';
            
            reportHTML += '<div class="report-section" style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">';
            reportHTML += '<p>_______________________________</p>';
            reportHTML += '<p>' + (sig.name || 'Assinatura do Profissional') + '</p>';
            if (sig.crefito) reportHTML += '<p>' + sig.crefito + '</p>';
            reportHTML += '</div>';
            
            // Vers√£o texto para WhatsApp
            let reportText = '*' + sig.clinic + '*\n';
            if (sig.name) reportText += sig.name + '\n';
            if (sig.crefito) reportText += sig.crefito + '\n';
            reportText += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            reportText += '*RELAT√ìRIO MENSAL*\n';
            reportText += 'Paciente: ' + patient.name + '\n';
            reportText += 'Per√≠odo: ' + monthName + '\n\n';
            reportText += '*SESS√ïES:* ' + monthAppts.length + '\n';
            monthAppts.forEach(a => {
                reportText += '‚Ä¢ ' + formatDate(a.date) + '\n';
            });
            reportText += '\n*EVOLU√á√ÉO:*\n';
            if (monthEvos.length === 0) {
                reportText += 'Nenhuma evolu√ß√£o registrada.\n';
            } else {
                monthEvos.forEach((evo, i) => {
                    reportText += '\n_Sess√£o ' + (i + 1) + ' - ' + formatDate(evo.date) + '_\n';
                    reportText += evo.text + '\n';
                });
            }
            
            currentReport = reportText;
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportContainer').style.display = 'block';
        }

        // PDF DO PACIENTE - AZUL MARINHO E DOURADO
        function generatePatientPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const sig = getProfessionalSignature();
            
            // Configurar cores
            const navyBlue = [38, 70, 83]; // #264653
            const gold = [212, 175, 55]; // #d4af37
            
            // Fundo azul marinho na borda
            doc.setFillColor(...navyBlue);
            doc.rect(0, 0, 210, 297, 'F');
            
            // Folha branca interna
            doc.setFillColor(255, 255, 255);
            doc.rect(10, 10, 190, 277, 'F');
            
            // Cabe√ßalho
            doc.setFillColor(...navyBlue);
            doc.rect(10, 10, 190, 40, 'F');
            
            // T√≠tulo em dourado
            doc.setTextColor(...gold);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text(sig.clinic, 105, 30, { align: 'center' });
            
            doc.setFontSize(12);
            if (sig.name) doc.text(sig.name, 105, 38, { align: 'center' });
            if (sig.crefito) doc.text(sig.crefito, 105, 44, { align: 'center' });
            
            // Conte√∫do em azul marinho
            let y = 65;
            doc.setTextColor(...navyBlue);
            
            // Dados do paciente
            const patient = patients.find(p => p.id === currentPatientId);
            const month = document.getElementById('reportMonthPatient').value;
            const monthName = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]) - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('RELAT√ìRIO MENSAL', 105, y, { align: 'center' });
            y += 10;
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('Paciente: ' + patient.name, 20, y);
            y += 7;
            doc.text('Per√≠odo: ' + monthName, 20, y);
            y += 15;
            
            // Sess√µes
            const monthAppts = appointments.filter(a => {
                if (a.patientId !== currentPatientId || a.cancelled) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === parseInt(month.split('-')[0]) && parseInt(ap[1]) === parseInt(month.split('-')[1]);
            });
            
            doc.setFont('helvetica', 'bold');
            doc.text('SESS√ïES REALIZADAS (' + monthAppts.length + ')', 20, y);
            y += 8;
            
            doc.setFont('helvetica', 'normal');
            if (monthAppts.length > 0) {
                monthAppts.forEach(a => {
                    doc.text('‚Ä¢ ' + formatDate(a.date) + ' √†s ' + a.time, 25, y);
                    y += 6;
                });
            } else {
                doc.text('Nenhuma sess√£o registrada.', 25, y);
                y += 6;
            }
            y += 10;
            
            // Evolu√ß√µes
            const monthEvos = evolutions.filter(e => {
                if (e.patientId !== currentPatientId) return false;
                const ep = e.date.split('-');
                return parseInt(ep[0]) === parseInt(month.split('-')[0]) && parseInt(ep[1]) === parseInt(month.split('-')[1]);
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            doc.setFont('helvetica', 'bold');
            doc.text('EVOLU√á√ÉO CL√çNICA', 20, y);
            y += 8;
            
            doc.setFont('helvetica', 'normal');
            if (monthEvos.length === 0) {
                doc.text('Nenhuma evolu√ß√£o registrada neste per√≠odo.', 25, y);
                y += 6;
            } else {
                monthEvos.forEach((evo, i) => {
                    // Verificar se precisa de nova p√°gina
                    if (y > 270) {
                        doc.addPage();
                        doc.setFillColor(...navyBlue);
                        doc.rect(0, 0, 210, 297, 'F');
                        doc.setFillColor(255, 255, 255);
                        doc.rect(10, 10, 190, 277, 'F');
                        y = 25;
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...gold);
                    doc.text('Sess√£o ' + (i + 1) + ' - ' + formatDate(evo.date), 25, y);
                    y += 6;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...navyBlue);
                    
                    // Quebrar texto em linhas
                    const lines = doc.splitTextToSize(evo.text, 160);
                    lines.forEach(line => {
                        if (y > 270) {
                            doc.addPage();
                            doc.setFillColor(...navyBlue);
                            doc.rect(0, 0, 210, 297, 'F');
                            doc.setFillColor(255, 255, 255);
                            doc.rect(10, 10, 190, 277, 'F');
                            y = 25;
                        }
                        doc.text(line, 25, y);
                        y += 5;
                    });
                    y += 8;
                });
            }
            
            // Assinatura
            if (y > 250) {
                doc.addPage();
                doc.setFillColor(...navyBlue);
                doc.rect(0, 0, 210, 297, 'F');
                doc.setFillColor(255, 255, 255);
                doc.rect(10, 10, 190, 277, 'F');
                y = 200;
            } else {
                y = 250;
            }
            
            doc.setTextColor(...navyBlue);
            doc.line(60, y, 150, y);
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.text(sig.name || 'Assinatura do Profissional', 105, y, { align: 'center' });
            if (sig.crefito) {
                y += 6;
                doc.text(sig.crefito, 105, y, { align: 'center' });
            }
            
            // Rodap√©
            doc.setFillColor(...navyBlue);
            doc.rect(10, 280, 190, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('¬© 2024 ASM Gest√£o Cl√≠nica - Todos os direitos reservados', 105, 285, { align: 'center' });
            
            doc.save('Relatorio_' + patient.name.split(' ')[0] + '_' + month + '.pdf');
        }

        function copyReport() {
            navigator.clipboard.writeText(currentReport).then(() => alert('Relat√≥rio copiado!'));
        }

        function sendReportWhatsApp() {
            const patient = patients.find(p => p.id === currentPatientId);
            window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(currentReport), '_blank');
        }

        // FLUXO DE CAIXA
        function openExpenseModal() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseModal').classList.add('active');
        }

        function saveExpense() {
            const data = {
                id: Date.now().toString(),
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDesc').value,
                category: document.getElementById('expenseCategory').value,
                value: parseFloat(document.getElementById('expenseValue').value)
            };
            
            if (!data.date || !data.description || !data.value) {
                alert('Preencha todos os campos!');
                return;
            }
            
            expenses.push(data);
            localStorage.setItem('asm_expenses', JSON.stringify(expenses));
            
            closeModal('expenseModal');
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseValue').value = '';
            renderCashFlow();
        }

        function showCashFlowTab(tab) {
            document.querySelectorAll('#fluxo .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#fluxo .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('cf' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.add('active');
        }

        function renderCashFlow() {
            const month = document.getElementById('cashFlowMonth').value;
            if (!month) return;
            
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            
            const entries = appointments.filter(a => {
                if (!a.paid || a.cancelled) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const exits = expenses.filter(e => {
                const ep = e.date.split('-');
                return parseInt(ep[0]) === year && parseInt(ep[1]) === mon;
            });
            
            const totalEntries = entries.reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const totalExits = exits.reduce((s, e) => s + parseFloat(e.value || 0), 0);
            
            document.getElementById('cfEntries').textContent = 'R$ ' + totalEntries.toFixed(2);
            document.getElementById('cfExits').textContent = 'R$ ' + totalExits.toFixed(2);
            document.getElementById('cfBalance').textContent = 'R$ ' + (totalEntries - totalExits).toFixed(2);
            
            // Entries table
            const entriesBody = document.getElementById('entriesTable');
            entriesBody.innerHTML = '';
            entries.forEach(a => {
                const p = patients.find(x => x.id === a.patientId);
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + formatDate(a.date) + '</td><td>' + (p ? p.name : '-') + '</td><td>' + a.type + '</td><td>R$ ' + parseFloat(a.value || 0).toFixed(2) + '</td>';
                entriesBody.appendChild(row);
            });
            
            // Exits table
            const exitsBody = document.getElementById('exitsTable');
            exitsBody.innerHTML = '';
            exits.forEach(e => {
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + formatDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.category + '</td><td>R$ ' + parseFloat(e.value).toFixed(2) + '</td><td><button class="btn btn-danger" onclick="deleteExpense(\'' + e.id + '\')">Excluir</button></td>';
                exitsBody.appendChild(row);
            });
        }

        function deleteExpense(id) {
            if (!confirm('Excluir esta despesa?')) return;
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('asm_expenses', JSON.stringify(expenses));
            renderCashFlow();
        }

        // RELAT√ìRIOS GERAIS FUNCIONAL
        function renderReports() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;
            
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            
            const monthAppts = appointments.filter(a => {
                if (a.cancelled) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const revenue = monthAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('reportSessions').textContent = monthAppts.length;
            document.getElementById('reportRevenue').textContent = 'R$ ' + revenue.toFixed(2);
            
            // Mostrar bot√µes de a√ß√£o
            if (monthAppts.length > 0) {
                document.getElementById('mainReportActions').style.display = 'block';
            } else {
                document.getElementById('mainReportActions').style.display = 'none';
            }
            
            // Group by patient
            const stats = {};
            monthAppts.forEach(a => {
                if (!stats[a.patientId]) stats[a.patientId] = { count: 0, total: 0, name: '' };
                const p = patients.find(x => x.id === a.patientId);
                stats[a.patientId].name = p ? p.name : '-';
                stats[a.patientId].count++;
                if (a.paid) stats[a.patientId].total += parseFloat(a.value || 0);
            });
            
            const tbody = document.getElementById('reportTable');
            tbody.innerHTML = '';
            
            // Preparar dados para relat√≥rio
            let reportData = [];
            for (let pid in stats) {
                const s = stats[pid];
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + s.name + '</td><td>' + s.count + '</td><td>R$ ' + s.total.toFixed(2) + '</td>';
                tbody.appendChild(row);
                
                reportData.push({
                    name: s.name,
                    sessions: s.count,
                    total: s.total
                });
            }
            
            // Gerar texto do relat√≥rio principal
            const sig = getProfessionalSignature();
            const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            let reportText = '*' + sig.clinic + '*\n';
            if (sig.name) reportText += sig.name + '\n';
            if (sig.crefito) reportText += sig.crefito + '\n';
            reportText += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            reportText += '*RELAT√ìRIO GERENCIAL - ' + monthName.toUpperCase() + '*\n\n';
            reportText += 'üìä *RESUMO DO M√äS*\n';
            reportText += 'Total de atendimentos: ' + monthAppts.length + '\n';
            reportText += 'Faturamento: R$ ' + revenue.toFixed(2) + '\n\n';
            reportText += 'üë• *PACIENTES ATENDIDOS*\n';
            
            reportData.forEach((item, idx) => {
                reportText += (idx + 1) + '. ' + item.name + '\n';
                reportText += '   Sess√µes: ' + item.sessions + ' | Total: R$ ' + item.total.toFixed(2) + '\n';
            });
            
            currentMainReport = reportText;
            
            // Preview
            let previewHTML = '<h3>' + sig.clinic + '</h3>';
            if (sig.name) previewHTML += '<p><strong>' + sig.name + '</strong></p>';
            previewHTML += '<h4>Relat√≥rio Gerencial - ' + monthName + '</h4>';
            previewHTML += '<p><strong>Total de atendimentos:</strong> ' + monthAppts.length + '</p>';
            previewHTML += '<p><strong>Faturamento:</strong> R$ ' + revenue.toFixed(2) + '</p>';
            previewHTML += '<h4>Pacientes Atendidos:</h4><ul>';
            reportData.forEach(item => {
                previewHTML += '<li>' + item.name + ' - ' + item.sessions + ' sess√µes (R$ ' + item.total.toFixed(2) + ')</li>';
            });
            previewHTML += '</ul>';
            
            document.getElementById('mainReportContent').innerHTML = previewHTML;
            document.getElementById('mainReportPreview').style.display = 'block';
        }

        // PDF DO RELAT√ìRIO PRINCIPAL
        function generateMainPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const sig = getProfessionalSignature();
            const month = document.getElementById('reportMonth').value;
            const monthName = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]) - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            // Configurar cores
            const navyBlue = [38, 70, 83];
            const gold = [212, 175, 55];
            
            // Fundo azul marinho
            doc.setFillColor(...navyBlue);
            doc.rect(0, 0, 210, 297, 'F');
            
            // Folha branca interna
            doc.setFillColor(255, 255, 255);
            doc.rect(10, 10, 190, 277, 'F');
            
            // Cabe√ßalho
            doc.setFillColor(...navyBlue);
            doc.rect(10, 10, 190, 35, 'F');
            
            // T√≠tulo em dourado
            doc.setTextColor(...gold);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(sig.clinic, 105, 28, { align: 'center' });
            
            doc.setFontSize(11);
            if (sig.name) doc.text(sig.name, 105, 35, { align: 'center' });
            if (sig.crefito) doc.text(sig.crefito, 105, 40, { align: 'center' });
            
            // Conte√∫do
            let y = 60;
            doc.setTextColor(...navyBlue);
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('RELAT√ìRIO GERENCIAL', 105, y, { align: 'center' });
            y += 10;
            
            doc.setFontSize(12);
            doc.text(monthName.toUpperCase(), 105, y, { align: 'center' });
            y += 15;
            
            // Dados
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            
            const monthAppts = appointments.filter(a => {
                if (a.cancelled) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const revenue = monthAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO DO M√äS', 20, y);
            y += 10;
            
            doc.setFont('helvetica', 'normal');
            doc.text('Total de atendimentos: ' + monthAppts.length, 25, y);
            y += 7;
            doc.text('Faturamento: R$ ' + revenue.toFixed(2), 25, y);
            y += 15;
            
            // Tabela de pacientes
            doc.setFont('helvetica', 'bold');
            doc.text('PACIENTES ATENDIDOS', 20, y);
            y += 10;
            
            // Cabe√ßalho da tabela
            doc.setFillColor(...navyBlue);
            doc.rect(20, y - 5, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('Paciente', 25, y);
            doc.text('Sess√µes', 120, y);
            doc.text('Total', 160, y);
            y += 10;
            
            // Dados
            const stats = {};
            monthAppts.forEach(a => {
                if (!stats[a.patientId]) stats[a.patientId] = { count: 0, total: 0 };
                stats[a.patientId].count++;
                if (a.paid) stats[a.patientId].total += parseFloat(a.value || 0);
            });
            
            doc.setTextColor(...navyBlue);
            doc.setFont('helvetica', 'normal');
            
            for (let pid in stats) {
                const p = patients.find(x => x.id === pid);
                const s = stats[pid];
                
                if (y > 270) {
                    doc.addPage();
                    doc.setFillColor(...navyBlue);
                    doc.rect(0, 0, 210, 297, 'F');
                    doc.setFillColor(255, 255, 255);
                    doc.rect(10, 10, 190, 277, 'F');
                    y = 25;
                }
                
                doc.text((p ? p.name.substring(0, 35) : '-'), 25, y);
                doc.text(s.count.toString(), 125, y);
                doc.text('R$ ' + s.total.toFixed(2), 160, y);
                y += 7;
            }
            
            // Rodap√©
            doc.setFillColor(...navyBlue);
            doc.rect(10, 280, 190, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('¬© 2024 ASM Gest√£o Cl√≠nica - Todos os direitos reservados', 105, 285, { align: 'center' });
            
            doc.save('Relatorio_Gerencial_' + month + '.pdf');
        }

        function sendMainReportWhatsApp() {
            window.open('https://wa.me/?text=' + encodeURIComponent(currentMainReport), '_blank');
        }

        // EXPORTAR EXCEL
        function exportToExcel() {
            let csv = 'Paciente;Data;Servico;Valor;Status\n';
            
            appointments.filter(a => !a.cancelled).forEach(a => {
                const p = patients.find(x => x.id === a.patientId);
                csv += (p ? p.name : '-') + ';' + formatDate(a.date) + ';' + a.type + ';' + parseFloat(a.value || 0).toFixed(2) + ';' + (a.paid ? 'Pago' : 'Pendente') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ASM_Financeiro_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        // UTILIT√ÅRIOS
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            return parts[2] + '/' + parts[1] + '/' + parts[0];
        }

        function loadPatientSelect() {
            const select = document.getElementById('apptPatient');
            select.innerHTML = '<option value="">Selecione...</option>';
            patients.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal').forEach(m => {
            m.onclick = function(e) {
                if (e.target === this) this.classList.remove('active');
            };
        });
    </script>
</body>
</html>
