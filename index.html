<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM Gest√£o Cl√≠nica</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #264653 0%, #2a9d8f 100%); }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 90%; max-width: 400px; text-align: center; }
        .login-box h1 { color: #264653; margin-bottom: 10px; font-size: 28px; }
        .login-box h2 { color: #666; font-size: 18px; margin-bottom: 30px; font-weight: normal; }
        .login-box .form-group { margin-bottom: 20px; text-align: left; }
        .login-box input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .login-btn { width: 100%; padding: 14px; background: #2a9d8f; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .login-error { color: #e76f51; margin-top: 15px; display: none; }
        .admin-badge { display: inline-block; background: #f4a261; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .header { background: #264653; color: white; padding: 15px; text-align: center; }
        .user-bar { background: #1a3a47; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .user-bar button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        .nav { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #2a9d8f; flex-wrap: wrap; }
        .nav button { padding: 10px 20px; border: none; background: rgba(255,255,255,0.2); color: white; border-radius: 5px; cursor: pointer; }
        .nav button:hover, .nav button.active { background: white; color: #264653; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .section { display: none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn-primary { background: #2a9d8f; color: white; }
        .btn-success { background: #52b788; color: white; }
        .btn-danger { background: #e76f51; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-warning { background: #f4a261; color: white; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; }
        .card:hover { border-color: #2a9d8f; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        .calendar-header { text-align: center; font-weight: bold; padding: 10px; background: #264653; color: white; }
        .calendar-day { background: #f8f9fa; min-height: 100px; padding: 10px; border-radius: 5px; cursor: pointer; }
        .appointment { background: #2a9d8f; color: white; padding: 5px; margin: 2px 0; border-radius: 3px; font-size: 12px; display: flex; justify-content: space-between; }
        .appointment.cancelled { background: #adb5bd; text-decoration: line-through; opacity: 0.7; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .summary-card { padding: 20px; border-radius: 10px; text-align: center; color: white; }
        .summary-card.green { background: #52b788; }
        .summary-card.red { background: #e76f51; }
        .summary-card.blue { background: #264653; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; background: none; border: none; cursor: pointer; }
        .tab.active { color: #2a9d8f; border-bottom: 2px solid #2a9d8f; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .settings-box { background: #e8f4f8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #264653; }
        .footer { text-align: center; padding: 20px; background: #264653; color: white; margin-top: 40px; font-size: 12px; }
        .user-card { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #2a9d8f; display: flex; justify-content: space-between; align-items: center; }
        .user-card.blocked { border-left-color: #e76f51; opacity: 0.7; }
        .session-checkbox { margin-right: 10px; transform: scale(1.2); }
        .session-row { cursor: pointer; }
        .session-row:hover { background: #f0f8ff; }
        .session-row.selected { background: #e0f2f1; }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üè• ASM Gest√£o Cl√≠nica</h1>
            <h2>Login do Profissional</h2>
            <div class="form-group">
                <label>Usu√°rio</label>
                <input type="text" id="loginUser" placeholder="Digite seu usu√°rio">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="loginPass" placeholder="Digite sua senha">
            </div>
            <button class="login-btn" onclick="doLogin()">Entrar</button>
            <div id="loginError" class="login-error">Usu√°rio ou senha incorretos!</div>
        </div>
    </div>

    <div id="mainSystem" style="display: none;">
        <div class="header">
            <h1>üè• ASM Gest√£o Cl√≠nica</h1>
            <p id="headerSubtitle">Sistema de Gest√£o para Fisioterapeutas</p>
        </div>
        
        <div class="user-bar">
            <div>üë§ <span id="currentUserName"></span><span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span></div>
            <div><button onclick="logout()">üö™ Sair</button></div>
        </div>
        
        <div class="nav">
            <button class="active" onclick="showSection('agenda')">üìÖ Agenda</button>
            <button onclick="showSection('pacientes')">üë• Pacientes</button>
            <button onclick="showSection('financeiro')">üí∞ Financeiro</button>
            <button onclick="showSection('fluxo')">üìä Fluxo de Caixa</button>
            <button onclick="showSection('relatorios')">üìà Relat√≥rios</button>
            <button onclick="showSection('configuracoes')">‚öôÔ∏è Configura√ß√µes</button>
            <button id="btnUsuarios" onclick="showSection('usuarios')" style="display: none;">üë§ Usu√°rios</button>
        </div>
        
        <div class="container">
            <div id="usuarios" class="section">
                <h2>üë§ Gerenciamento de Usu√°rios</h2>
                <div class="settings-box">
                    <h3>Novo Usu√°rio</h3>
                    <div class="form-group"><label>Nome *</label><input type="text" id="newUserName" placeholder="Ex: Dra. Maria Silva"></div>
                    <div class="form-group"><label>CREFITO *</label><input type="text" id="newUserCrefito" placeholder="Ex: 123456-F"></div>
                    <div class="form-group"><label>Empresa (opcional)</label><input type="text" id="newUserClinic" placeholder="Ex: ASM Fisioterapia"></div>
                    <div class="form-group"><label>Chave Pix *</label><input type="text" id="newUserPix" placeholder="Ex: CPF, CNPJ, e-mail ou telefone"></div>
                    <div class="form-group"><label>Usu√°rio *</label><input type="text" id="newUserLogin" placeholder="Ex: maria.silva"></div>
                    <div class="form-group"><label>Senha *</label><input type="password" id="newUserPass" placeholder="M√≠nimo 6 caracteres"></div>
                    <div class="form-group"><label>Confirmar Senha *</label><input type="password" id="newUserPass2" placeholder="Digite a senha novamente"></div>
                    <button class="btn btn-primary" onclick="createUser()">‚ûï Criar Usu√°rio</button>
                </div>
                <h3>Usu√°rios Cadastrados</h3>
                <div id="usersList"></div>
            </div>
            
            <div id="configuracoes" class="section">
                <h2>‚öôÔ∏è Configura√ß√µes</h2>
                <div class="settings-box">
                    <div class="form-group"><label>Nome *</label><input type="text" id="configName"></div>
                    <div class="form-group"><label>CREFITO *</label><input type="text" id="configCrefito"></div>
                    <div class="form-group"><label>Cl√≠nica (opcional)</label><input type="text" id="configClinic"></div>
                    <div class="form-group"><label>Chave Pix</label><input type="text" id="configPix"></div>
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar</button>
                </div>
            </div>
            
            <div id="agenda" class="section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Agenda</h2>
                    <button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo</button>
                </div>
                <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê</button>
                    <h3 id="currentMonth"></h3>
                    <button class="btn btn-primary" onclick="changeMonth(1)">‚Üí</button>
                </div>
                <div class="calendar" id="calendar"></div>
            </div>
            
            <div id="pacientes" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Pacientes</h2>
                    <button class="btn btn-primary" onclick="openPatientModal()">+ Novo</button>
                </div>
                <input type="text" style="width: 100%; padding: 10px; margin-bottom: 20px;" placeholder="Buscar..." oninput="searchPatients(this.value)">
                <div class="grid" id="patientsList"></div>
            </div>
            
            <div id="financeiro" class="section">
                <h2>Financeiro</h2>
                <div class="summary-cards">
                    <div class="summary-card green"><h3 id="totalReceived">R$ 0,00</h3><p>Recebido</p></div>
                    <div class="summary-card red"><h3 id="totalPending">R$ 0,00</h3><p>A Receber</p></div>
                    <div class="summary-card blue"><h3 id="totalSessions">0</h3><p>Sess√µes</p></div>
                </div>
                <table>
                    <thead><tr><th>Paciente</th><th>Data</th><th>Servi√ßo</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="financialTable"></tbody>
                </table>
            </div>
            
            <div id="fluxo" class="section">
                <h2>Fluxo de Caixa</h2>
                <div class="form-group"><label>M√™s/Ano</label><input type="month" id="cashFlowMonth" onchange="renderCashFlow()"></div>
                <div class="summary-cards">
                    <div class="summary-card green"><h3 id="cfEntries">R$ 0,00</h3><p>Entradas</p></div>
                    <div class="summary-card red"><h3 id="cfExits">R$ 0,00</h3><p>Sa√≠das</p></div>
                    <div class="summary-card blue"><h3 id="cfBalance">R$ 0,00</h3><p>Saldo</p></div>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="showCashFlowTab('entries')">Entradas</button>
                    <button class="tab" onclick="showCashFlowTab('exits')">Despesas</button>
                </div>
                <div id="cfEntriesTab" class="tab-content active">
                    <table><thead><tr><th>Data</th><th>Paciente</th><th>Servi√ßo</th><th>Valor</th></tr></thead><tbody id="entriesTable"></tbody></table>
                </div>
                <div id="cfExitsTab" class="tab-content">
                    <table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="exitsTable"></tbody></table>
                </div>
            </div>
            
            <div id="relatorios" class="section">
                <h2>Relat√≥rios</h2>
                <div class="form-group"><label>M√™s/Ano</label><input type="month" id="reportMonth" onchange="renderReports()"></div>
                <div class="summary-cards">
                    <div class="summary-card blue"><h3 id="reportSessions">0</h3><p>Atendimentos</p></div>
                    <div class="summary-card green"><h3 id="reportRevenue">R$ 0,00</h3><p>Faturamento</p></div>
                </div>
                <table><thead><tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr></thead><tbody id="reportTable"></tbody></table>
            </div>
        </div>
        
        <div class="modal" id="appointmentModal">
            <div class="modal-content">
                <div class="modal-header"><h3>Agendamento</h3><button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button></div>
                <div class="form-group"><label>Paciente *</label><select id="apptPatient"></select></div>
                <div class="form-group"><label>Data *</label><input type="date" id="apptDate"></div>
                <div class="form-group"><label>Hor√°rio *</label><input type="time" id="apptTime"></div>
                <div class="form-group"><label>Tipo</label><select id="apptType"><option value="normal">Normal</option><option value="laser">Laser</option><option value="avaliacao">Avalia√ß√£o</option></select></div>
                <div class="form-group"><label>Valor (R$)</label><input type="number" id="apptValue" step="0.01"></div>
                <div class="form-group"><label>Observa√ß√µes</label><textarea id="apptNotes" rows="3"></textarea></div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-whatsapp" id="btnWhatsAppt" onclick="sendAppointmentWhatsApp()" style="display: none;">üì± WhatsApp</button>
                    <button class="btn btn-warning" id="btnToggleCancel" onclick="toggleCancelAppointment()" style="display: none;">‚ùå Cancelar</button>
                    <button class="btn btn-primary" onclick="saveAppointment()" style="margin-left: auto;">Salvar</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="patientModal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header"><h3 id="patientModalTitle">Novo Paciente</h3><button class="close-btn" onclick="closeModal('patientModal')">&times;</button></div>
                <div class="tabs">
                    <button class="tab active" onclick="showPatientTab('info')">Informa√ß√µes</button>
                    <button class="tab" onclick="showPatientTab('financeiro')">Financeiro</button>
                    <button class="tab" onclick="showPatientTab('evolucao')">Evolu√ß√£o</button>
                    <button class="tab" onclick="showPatientTab('relatorio')">Relat√≥rio</button>
                </div>
                
                <div id="tabInfo" class="tab-content active">
                    <input type="hidden" id="patientId">
                    <div class="form-group"><label>Nome *</label><input type="text" id="patientName"></div>
                    <div class="form-group"><label>Telefone *</label><input type="tel" id="patientPhone" placeholder="(00) 00000-0000"></div>
                    <div class="form-group"><label>E-mail</label><input type="email" id="patientEmail"></div>
                    <div class="form-group"><label>Valor Padr√£o</label><input type="number" id="patientValue" step="0.01"></div>
                    <div class="form-group"><label>Queixa</label><textarea id="patientComplaint" rows="3"></textarea></div>
                </div>
                
                <div id="tabFinanceiro" class="tab-content">
                    <div class="summary-cards">
                        <div class="summary-card green"><h3 id="patientPaid">R$ 0,00</h3><p>Pago</p></div>
                        <div class="summary-card red"><h3 id="patientPending">R$ 0,00</h3><p>Pendente</p></div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-whatsapp" onclick="sendPendingSessionsWhatsApp()">üì± Cobrar Selecionadas</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllSessions" onchange="toggleAllSessions()"></th>
                                <th>Data</th><th>Servi√ßo</th><th>Valor</th><th>Status</th><th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="patientFinanceTable"></tbody>
                    </table>
                </div>
                
                <div id="tabEvolucao" class="tab-content">
                    <div class="form-group">
                        <label>Nova Evolu√ß√£o</label>
                        <textarea id="newEvolution" rows="4" placeholder="Descreva..."></textarea>
                        <button class="btn btn-primary" onclick="addEvolution()">Salvar</button>
                    </div>
                    <div id="evolutionsList"></div>
                </div>
                
                <div id="tabRelatorio" class="tab-content">
                    <div class="form-group"><label>M√™s/Ano</label><input type="month" id="reportMonthPatient"></div>
                    <button class="btn btn-primary" onclick="generatePatientReport()">Gerar Relat√≥rio</button>
                    <div id="reportContainer" style="display: none; margin-top: 20px;">
                        <div class="report-box" id="reportContent" style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: monospace;"></div>
                        <button class="btn btn-primary" onclick="copyReport()">Copiar</button>
                        <button class="btn btn-whatsapp" onclick="sendReportWhatsApp()">üì± WhatsApp</button>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()">Excluir</button>
                    <button class="btn btn-primary" onclick="savePatient()">Salvar</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="expenseModal">
            <div class="modal-content">
                <div class="modal-header"><h3>Nova Despesa</h3><button class="close-btn" onclick="closeModal('expenseModal')">&times;</button></div>
                <div class="form-group"><label>Data *</label><input type="date" id="expenseDate"></div>
                <div class="form-group"><label>Descri√ß√£o *</label><input type="text" id="expenseDesc"></div>
                <div class="form-group"><label>Categoria</label><select id="expenseCategory"><option value="material">Material</option><option value="aluguel">Aluguel</option><option value="servicos">Servi√ßos</option><option value="outros">Outros</option></select></div>
                <div class="form-group"><label>Valor (R$) *</label><input type="number" id="expenseValue" step="0.01"></div>
                <button class="btn btn-primary" onclick="saveExpense()">Salvar</button>
            </div>
        </div>

        <div class="footer">
            <p><strong>ASM Gest√£o Cl√≠nica</strong></p>
            <p>¬© 2024 Dra. Andresa Augusto - Todos os direitos reservados</p>
            <p>Proibida reprodu√ß√£o sem autoriza√ß√£o</p>
        </div>
    </div>

parte2 = '''
    <script>
        let users = JSON.parse(localStorage.getItem('asm_users')) || {
            'admin': { name: 'Administrador', password: 'admin123', isAdmin: true, isBlocked: false, createdAt: new Date().toISOString(), crefito: '', clinic: '', pix: '' }
        };
        let currentUser = null;
        let selectedSessions = new Set();
        let config = {}, patients = [], appointments = [], evolutions = [], expenses = [];
        let currentDate = new Date(), currentPatientId = null, currentApptId = null, currentReport = '';

        function saveUsers() { localStorage.setItem('asm_users', JSON.stringify(users)); }
        
        function doLogin() {
            const username = document.getElementById('loginUser').value.trim().toLowerCase();
            const password = document.getElementById('loginPass').value;
            if (!username || !password) { showLoginError('Preencha usu√°rio e senha!'); return; }
            const user = users[username];
            if (!user || user.password !== password) { showLoginError('Usu√°rio ou senha incorretos!'); return; }
            if (user.isBlocked) { showLoginError('Usu√°rio bloqueado.'); return; }
            currentUser = username;
            localStorage.setItem('asm_current_user', username);
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            document.getElementById('currentUserName').textContent = user.name;
            if (user.isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.getElementById('btnUsuarios').style.display = 'inline-block';
                renderUsersList();
            }
            loadUserData();
            initializeApp();
        }
        
        function showLoginError(msg) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 3000);
        }
        
        function logout() { currentUser = null; localStorage.removeItem('asm_current_user'); location.reload(); }
        
        function checkSession() {
            const savedUser = localStorage.getItem('asm_current_user');
            if (savedUser && users[savedUser] && !users[savedUser].isBlocked) {
                document.getElementById('loginUser').value = savedUser;
                document.getElementById('loginPass').focus();
            }
        }
        
        function createUser() {
            const name = document.getElementById('newUserName').value.trim();
            const crefito = document.getElementById('newUserCrefito').value.trim();
            const clinic = document.getElementById('newUserClinic').value.trim();
            const pix = document.getElementById('newUserPix').value.trim();
            const login = document.getElementById('newUserLogin').value.trim().toLowerCase();
            const pass = document.getElementById('newUserPass').value;
            const pass2 = document.getElementById('newUserPass2').value;
            
            if (!name || !crefito || !pix || !login || !pass) { alert('Preencha todos os campos obrigat√≥rios!'); return; }
            if (pass.length < 6) { alert('Senha m√≠nima de 6 caracteres!'); return; }
            if (pass !== pass2) { alert('Senhas n√£o conferem!'); return; }
            if (users[login]) { alert('Usu√°rio j√° existe!'); return; }
            
            users[login] = { name, password: pass, isAdmin: false, isBlocked: false, createdAt: new Date().toISOString(), crefito, clinic: clinic || 'ASM Fisioterapia', pix };
            saveUsers();
            
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserCrefito').value = '';
            document.getElementById('newUserClinic').value = '';
            document.getElementById('newUserPix').value = '';
            document.getElementById('newUserLogin').value = '';
            document.getElementById('newUserPass').value = '';
            document.getElementById('newUserPass2').value = '';
            
            renderUsersList();
            alert('Usu√°rio criado!\\nLogin: ' + login + '\\nSenha: ' + pass);
        }
        
        function renderUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            for (let login in users) {
                const user = users[login];
                const div = document.createElement('div');
                div.className = 'user-card' + (user.isBlocked ? ' blocked' : '');
                let html = '<div class="user-info"><h4>' + user.name + ' ' + (user.isAdmin ? '<span class="admin-badge">ADMIN</span>' : '') + '</h4>';
                html += '<small>Login: ' + login + ' | CREFITO: ' + (user.crefito || '-') + ' | Pix: ' + (user.pix || '-') + '</small></div>';
                html += '<div>';
                if (login !== 'admin') {
                    html += '<button class="btn btn-warning" onclick="toggleBlockUser(\\'' + login + '\\')">' + (user.isBlocked ? 'Desbloquear' : 'Bloquear') + '</button> ';
                    html += '<button class="btn btn-danger" onclick="deleteUser(\\'' + login + '\\')">Excluir</button>';
                } else { html += '<small>(N√£o alter√°vel)</small>'; }
                html += '</div>';
                div.innerHTML = html;
                container.appendChild(div);
            }
        }
        
        function toggleBlockUser(login) {
            if (!confirm('Tem certeza?')) return;
            users[login].isBlocked = !users[login].isBlocked;
            saveUsers();
            renderUsersList();
        }
        
        function deleteUser(login) {
            if (!confirm('ATEN√á√ÉO: Excluir√° TODOS os dados deste usu√°rio!\\nTem certeza?')) return;
            localStorage.removeItem('asm_patients_' + login);
            localStorage.removeItem('asm_appointments_' + login);
            localStorage.removeItem('asm_evolutions_' + login);
            localStorage.removeItem('asm_expenses_' + login);
            localStorage.removeItem('asm_config_' + login);
            delete users[login];
            saveUsers();
            renderUsersList();
        }
        
        function loadUserData() {
            const prefix = 'asm_' + currentUser + '_';
            const userData = users[currentUser];
            config = JSON.parse(localStorage.getItem(prefix + 'config')) || {
                professionalName: userData.name, crefito: userData.crefito || '', clinicName: userData.clinic || 'ASM Fisioterapia', pix: userData.pix || ''
            };
            patients = JSON.parse(localStorage.getItem(prefix + 'patients')) || [];
            appointments = JSON.parse(localStorage.getItem(prefix + 'appointments')) || [];
            evolutions = JSON.parse(localStorage.getItem(prefix + 'evolutions')) || [];
            expenses = JSON.parse(localStorage.getItem(prefix + 'expenses')) || [];
        }
        
        function saveUserData() {
            const prefix = 'asm_' + currentUser + '_';
            localStorage.setItem(prefix + 'config', JSON.stringify(config));
            localStorage.setItem(prefix + 'patients', JSON.stringify(patients));
            localStorage.setItem(prefix + 'appointments', JSON.stringify(appointments));
            localStorage.setItem(prefix + 'evolutions', JSON.stringify(evolutions));
            localStorage.setItem(prefix + 'expenses', JSON.stringify(expenses));
        }
        
        function initializeApp() {
            loadConfig();
            renderCalendar();
            renderPatients();
            updateFinancialSummary();
            loadPatientSelect();
            const today = new Date().toISOString().slice(0, 7);
            document.getElementById('cashFlowMonth').value = today;
            document.getElementById('reportMonth').value = today;
        }

        function loadConfig() {
            document.getElementById('configName').value = config.professionalName;
            document.getElementById('configCrefito').value = config.crefito;
            document.getElementById('configClinic').value = config.clinicName;
            document.getElementById('configPix').value = config.pix || '';
            updateHeader();
        }
        
        function saveConfig() {
            config.professionalName = document.getElementById('configName').value.trim();
            config.crefito = document.getElementById('configCrefito').value.trim();
            config.clinicName = document.getElementById('configClinic').value.trim() || 'ASM Fisioterapia';
            config.pix = document.getElementById('configPix').value.trim();
            if (!config.professionalName || !config.crefito) { alert('Preencha nome e CREFITO!'); return; }
            saveUserData();
            updateHeader();
            alert('Configura√ß√µes salvas!');
        }
        
        function updateHeader() {
            const subtitle = document.getElementById('headerSubtitle');
            subtitle.textContent = config.professionalName ? config.professionalName + ' - CREFITO ' + config.crefito : 'Configure seus dados';
        }
        
        function getProfessionalSignature() {
            return { name: config.professionalName || 'Profissional', crefito: config.crefito ? 'CREFITO ' + config.crefito : '', clinic: config.clinicName || 'ASM Fisioterapia', pix: config.pix || '' };
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            if (section === 'financeiro') renderFinancialTable();
            if (section === 'fluxo') renderCashFlow();
            if (section === 'relatorios') renderReports();
            if (section === 'usuarios') renderUsersList();
        }

        function renderCalendar() {
            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            document.getElementById('currentMonth').textContent = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            days.forEach(day => { const div = document.createElement('div'); div.className = 'calendar-header'; div.textContent = day; calendar.appendChild(div); });
            for (let i = 0; i < firstDay; i++) calendar.appendChild(document.createElement('div'));
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerHTML = '<strong>' + day + '</strong>';
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) { div.style.background = '#2a9d8f'; div.style.color = 'white'; }
                const dayAppointments = appointments.filter(a => { const parts = a.date.split('-'); return parseInt(parts[0]) === year && (parseInt(parts[1]) - 1) === month && parseInt(parts[2]) === day; });
                dayAppointments.forEach(appt => {
                    const patient = patients.find(p => p.id === appt.patientId);
                    const apptDiv = document.createElement('div');
                    apptDiv.className = 'appointment' + (appt.cancelled ? ' cancelled' : '');
                    apptDiv.innerHTML = '<span>' + appt.time + ' ' + (patient ? patient.name.split(' ')[0] : '') + '</span>';
                    const actions = document.createElement('div');
                    actions.innerHTML = '<button onclick="event.stopPropagation(); editAppointment(\\'' + appt.id + '\\')">‚úé</button> <button onclick="event.stopPropagation(); toggleCancelAppointmentDirect(\\'' + appt.id + '\\')">' + (appt.cancelled ? '‚Ü©' : '‚úï') + '</button>';
                    apptDiv.appendChild(actions);
                    div.appendChild(apptDiv);
                });
                div.onclick = () => openAppointmentModal(year, month, day);
                calendar.appendChild(div);
            }
        }

        function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); renderCalendar(); }

        function renderPatients() {
            const list = document.getElementById('patientsList');
            list.innerHTML = '';
            patients.forEach(p => {
                const patientAppts = appointments.filter(a => a.patientId === p.id && !a.cancelled);
                const pending = patientAppts.filter(a => !a.paid).length;
                const card = document.createElement('div');
                card.className = 'card';
                let html = '<h3>' + p.name + '</h3><p>üì± ' + p.phone + '</p><p>üí∞ R$ ' + parseFloat(p.defaultValue || 0).toFixed(2) + '</p>';
                if (pending > 0) html += '<p style="color: #e76f51;">‚ö†Ô∏è ' + pending + ' pendente(s)</p>';
                card.innerHTML = html;
                card.onclick = () => openPatientModal(p.id);
                list.appendChild(card);
            });
        }

        function searchPatients(term) {
            document.querySelectorAll('#patientsList .card').forEach(card => {
                card.style.display = card.querySelector('h3').textContent.toLowerCase().includes(term.toLowerCase()) ? 'block' : 'none';
            });
        }

        function openPatientModal(patientId) {
            currentPatientId = patientId;
            selectedSessions.clear();
            document.getElementById('patientId').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientEmail').value = '';
            document.getElementById('patientValue').value = '';
            document.getElementById('patientComplaint').value = '';
            showPatientTab('info');
            if (patientId) {
                const p = patients.find(x => x.id === patientId);
                document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
                document.getElementById('patientId').value = p.id;
                document.getElementById('patientName').value = p.name;
                document.getElementById('patientPhone').value = p.phone;
                document.getElementById('patientEmail').value = p.email || '';
                document.getElementById('patientValue').value = p.defaultValue || '';
                document.getElementById('patientComplaint').value = p.complaint || '';
                document.getElementById('btnDeletePatient').style.display = 'block';
                renderPatientFinance();
                renderEvolutions();
            } else {
                document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
                document.getElementById('btnDeletePatient').style.display = 'none';
            }
            document.getElementById('patientModal').classList.add('active');
        }

        function savePatient() {
            const id = document.getElementById('patientId').value;
            const data = { id: id || Date.now().toString(), name: document.getElementById('patientName').value, phone: document.getElementById('patientPhone').value, email: document.getElementById('patientEmail').value, defaultValue: document.getElementById('patientValue').value, complaint: document.getElementById('patientComplaint').value };
            if (!data.name || !data.phone) { alert('Preencha nome e telefone!'); return; }
            if (id) { const idx = patients.findIndex(p => p.id === id); patients[idx] = data; } else { patients.push(data); }
            saveUserData();
            closeModal('patientModal');
            renderPatients();
            loadPatientSelect();
        }

        function deletePatient() {
            if (!confirm('Excluir paciente e todos os dados?')) return;
            patients = patients.filter(p => p.id !== currentPatientId);
            appointments = appointments.filter(a => a.patientId !== currentPatientId);
            evolutions = evolutions.filter(e => e.patientId !== currentPatientId);
            saveUserData();
            closeModal('patientModal');
            renderPatients();
            renderCalendar();
            updateFinancialSummary();
        }

        function showPatientTab(tab) {
            document.querySelectorAll('#patientModal .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if (tab === 'financeiro') renderPatientFinance();
            if (tab === 'evolucao') renderEvolutions();
        }

        function openAppointmentModal(year, month, day) {
            currentApptId = null;
            document.getElementById('apptPatient').value = '';
            document.getElementById('apptTime').value = '';
            document.getElementById('apptValue').value = '';
            document.getElementById('apptNotes').value = '';
            document.getElementById('btnWhatsAppt').style.display = 'none';
            document.getElementById('btnToggleCancel').style.display = 'none';
            if (year !== undefined) document.getElementById('apptDate').value = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            else document.getElementById('apptDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentModal').classList.add('active');
        }

        function editAppointment(id) {
            const appt = appointments.find(a => a.id === id);
            currentApptId = id;
            document.getElementById('apptPatient').value = appt.patientId;
            document.getElementById('apptDate').value = appt.date;
            document.getElementById('apptTime').value = appt.time;
            document.getElementById('apptType').value = appt.type;
            document.getElementById('apptValue').value = appt.value;
            document.getElementById('apptNotes').value = appt.notes || '';
            document.getElementById('btnWhatsAppt').style.display = 'inline-block';
            document.getElementById('btnToggleCancel').style.display = 'inline-block';
            const btnCancel = document.getElementById('btnToggleCancel');
            if (appt.cancelled) { btnCancel.textContent = '‚Ü© Reativar'; btnCancel.className = 'btn btn-success'; }
            else { btnCancel.textContent = '‚ùå Cancelar'; btnCancel.className = 'btn btn-warning'; }
            document.getElementById('appointmentModal').classList.add('active');
        }

        function saveAppointment() {
            const patientId = document.getElementById('apptPatient').value;
            if (!patientId) { alert('Selecione um paciente!'); return; }
            const patient = patients.find(p => p.id === patientId);
            const data = { id: currentApptId || Date.now().toString(), patientId, date: document.getElementById('apptDate').value, time: document.getElementById('apptTime').value, type: document.getElementById('apptType').value, value: document.getElementById('apptValue').value || patient.defaultValue || 0, notes: document.getElementById('apptNotes').value, paid: currentApptId ? appointments.find(a => a.id === currentApptId).paid : false, cancelled: currentApptId ? appointments.find(a => a.id === currentApptId).cancelled : false };
            if (currentApptId) { const idx = appointments.findIndex(a => a.id === currentApptId); appointments[idx] = data; } else { appointments.push(data); }
            saveUserData();
            closeModal('appointmentModal');
            renderCalendar();
            updateFinancialSummary();
        }

        function toggleCancelAppointment() { if (!currentApptId) return; toggleCancelAppointmentDirect(currentApptId); closeModal('appointmentModal'); }
        function toggleCancelAppointmentDirect(id) { const appt = appointments.find(a => a.id === id); appt.cancelled = !appt.cancelled; saveUserData(); renderCalendar(); updateFinancialSummary(); }

        function sendAppointmentWhatsApp() {
            if (!currentApptId) return;
            const appt = appointments.find(a => a.id === currentApptId);
            const patient = patients.find(p => p.id === appt.patientId);
            const sig = getProfessionalSignature();
            let msg = 'Ol√° ' + patient.name + ', tudo bem? üòä\\n\\nConfirma√ß√£o de agendamento:\\n\\nüìÖ Data: ' + formatDate(appt.date) + '\\n‚è∞ Hor√°rio: ' + appt.time + '\\nüè• Local: ' + sig.clinic + '\\n\\n';
            if (!appt.cancelled) { msg += 'Estamos te aguardando!' + (sig.name ? '\\nAtenciosamente, ' + sig.name : '') + (sig.crefito ? '\\n' + sig.crefito : ''); }
            else { msg += '‚ö†Ô∏è ATEN√á√ÉO: Agendamento CANCELADO.'; }
            window.open('https://wa.me/55' + patient.phone.replace(/\\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }

        function renderFinancialTable() {
            const tbody = document.getElementById('financialTable');
            tbody.innerHTML = '';
            appointments.filter(a => !a.cancelled).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(appt => {
                const patient = patients.find(p => p.id === appt.patientId);
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + (patient ? patient.name : '-') + '</td><td>' + formatDate(appt.date) + '</td><td>' + (appt.type === 'laser' ? 'Laser' : 'Normal') + '</td><td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td><td>' + (appt.paid ? '‚úÖ Pago' : '‚è≥ Pendente') + '</td><td><button class="btn btn-primary" onclick="togglePayment(\\'' + appt.id + '\\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                tbody.appendChild(row);
            });
        }

        function renderPatientFinance() {
            const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled);
            const paid = patientAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const pending = patientAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            document.getElementById('patientPaid').textContent = 'R$ ' + paid.toFixed(2);
            document.getElementById('patientPending').textContent = 'R$ ' + pending.toFixed(2);
            const tbody = document.getElementById('patientFinanceTable');
            tbody.innerHTML = '';
            patientAppts.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(appt => {
                const row = document.createElement('tr');
                row.className = 'session-row' + (selectedSessions.has(appt.id) ? ' selected' : '');
                row.onclick = (e) => { if (e.target.type !== 'checkbox') toggleSessionSelection(appt.id); };
                row.innerHTML = '<td><input type="checkbox" class="session-checkbox" ' + (selectedSessions.has(appt.id) ? 'checked' : '') + ' onchange="toggleSessionSelection(\\'' + appt.id + '\\')"></td><td>' + formatDate(appt.date) + '</td><td>' + appt.type + '</td><td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td><td>' + (appt.paid ? 'Pago' : 'Pendente') + '</td><td><button class="btn btn-primary" onclick="togglePayment(\\'' + appt.id + '\\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                tbody.appendChild(row);
            });
        }

        function toggleSessionSelection(apptId) {
            if (selectedSessions.has(apptId)) selectedSessions.delete(apptId);
            else selectedSessions.add(apptId);
            renderPatientFinance();
        }

        function toggleAllSessions() {
            const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && !a.paid);
            const allSelected = patientAppts.every(a => selectedSessions.has(a.id));
            patientAppts.forEach(a => allSelected ? selectedSessions.delete(a.id) : selectedSessions.add(a.id));
            renderPatientFinance();
            document.getElementById('selectAllSessions').checked = !allSelected;
        }

        function sendPendingSessionsWhatsApp() {
            if (selectedSessions.size === 0) { alert('Selecione pelo menos uma sess√£o!'); return; }
            const patient = patients.find(p => p.id === currentPatientId);
            const sig = getProfessionalSignature();
            let total = 0, sessionsList = '';
            const selectedAppts = appointments.filter(a => selectedSessions.has(a.id)).sort((a, b) => new Date(a.date) - new Date(b.date));
            selectedAppts.forEach((appt, index) => { total += parseFloat(appt.value || 0); sessionsList += (index + 1) + '. ' + formatDate(appt.date) + ' - R$ ' + parseFloat(appt.value || 0).toFixed(2) + '\\n'; });
            let msg = 'Ol√° ' + patient.name + ', tudo bem? üòä\\n\\nSess√µes em aberto:\\n\\n' + sessionsList + '\\nüí∞ *Total: R$ ' + total.toFixed(2) + '*\\n\\n';
            if (sig.pix) msg += 'üí≥ Chave Pix:\\n*' + sig.pix + '*\\n\\n';
            msg += 'Qualquer d√∫vida, estou √† disposi√ß√£o!' + (sig.name ? '\\n\\nAtenciosamente,\\n' + sig.name : '') + (sig.crefito ? '\\n' + sig.crefito : '');
            window.open('https://wa.me/55' + patient.phone.replace(/\\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }

        function updateFinancialSummary() {
            const activeAppts = appointments.filter(a => !a.cancelled);
            const received = activeAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const pending = activeAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            document.getElementById('totalReceived').textContent = 'R$ ' + received.toFixed(2);
            document.getElementById('totalPending').textContent = 'R$ ' + pending.toFixed(2);
            document.getElementById('totalSessions').textContent = activeAppts.length;
        }

        function togglePayment(id) {
            const appt = appointments.find(a => a.id === id);
            appt.paid = !appt.paid;
            saveUserData();
            renderFinancialTable();
            updateFinancialSummary();
            renderCalendar();
            if (currentPatientId) renderPatientFinance();
        }

        function renderEvolutions() {
            const list = document.getElementById('evolutionsList');
            list.innerHTML = '';
            evolutions.filter(e => e.patientId === currentPatientId).sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time)).forEach(evo => {
                const div = document.createElement('div');
                div.style.cssText = 'background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #2a9d8f;';
                div.innerHTML = '<small style="color: #666;">' + formatDate(evo.date) + ' √†s ' + evo.time + '</small><p style="margin-top: 5px;">' + evo.text + '</p>';
                list.appendChild(div);
            });
        }

        function addEvolution() {
            const text = document.getElementById('newEvolution').value;
            if (!text.trim()) return;
            const now = new Date();
            evolutions.push({ id: Date.now().toString(), patientId: currentPatientId, date: now.toISOString().split('T')[0], time: now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), text });
            saveUserData();
            document.getElementById('newEvolution').value = '';
            renderEvolutions();
        }

        function generatePatientReport() {
            const month = document.getElementById('reportMonthPatient').value;
            if (!month) { alert('Selecione o m√™s!'); return; }
            const sig = getProfessionalSignature();
            const [year, mon] = month.split('-').map(Number);
            const patient = patients.find(p => p.id === currentPatientId);
            const monthEvos = evolutions.filter(e => e.patientId === currentPatientId && e.date.startsWith(month)).sort((a, b) => new Date(a.date) - new Date(b.date));
            const monthAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && a.date.startsWith(month));
            const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            let report = 'RELAT√ìRIO MENSAL - ' + sig.clinic.toUpperCase() + '\\n' + (sig.name ? sig.name + '\\n' : '') + (sig.crefito ? sig.crefito + '\\n' : '') + '================================\\n\\nPaciente: ' + patient.name + '\\nPer√≠odo: ' + monthName + '\\n\\nüìã RESUMO\\nSess√µes: ' + monthAppts.length + '\\n\\n';
            if (monthAppts.length > 0) { report += 'Datas:\\n'; monthAppts.forEach(a => { report += '‚Ä¢ ' + formatDate(a.date) + ' - ' + a.time + '\\n'; }); report += '\\n'; }
            report += 'üìä EVOLU√á√ÉO\\n\\n';
            if (monthEvos.length === 0) report += 'Nenhuma evolu√ß√£o registrada.\\n';
            else monthEvos.forEach((evo, i) => { report += 'Sess√£o ' + (i + 1) + ' - ' + formatDate(evo.date) + '\\n' + evo.text + '\\n--------------------------------\\n\\n'; });
            report += '\\n' + sig.clinic + (sig.name ? '\\n' + sig.name : '') + (sig.crefito ? '\\n' + sig.crefito : '');
            currentReport = report;
            document.getElementById('reportContent').textContent = report;
            document.getElementById('reportContainer').style.display = 'block';
        }

        function copyReport() { navigator.clipboard.writeText(currentReport).then(() => alert('Copiado!')); }
        function sendReportWhatsApp() { const patient = patients.find(p => p.id === currentPatientId); window.open('https://wa.me/55' + patient.phone.replace(/\\D/g, '') + '?text=' + encodeURIComponent(currentReport), '_blank'); }

        function openExpenseModal() { document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0]; document.getElementById('expenseModal').classList.add('active'); }
        function saveExpense() {
            const data = { id: Date.now().toString(), date: document.getElementById('expenseDate').value, description: document.getElementById('expenseDesc').value, category: document.getElementById('expenseCategory').value, value: parseFloat(document.getElementById('expenseValue').value) };
            if (!data.date || !data.description || !data.value) { alert('Preencha todos os campos!'); return; }
            expenses.push(data);
            saveUserData();
            closeModal('expenseModal');
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseValue').value = '';
            renderCashFlow();
        }

        function showCashFlowTab(tab) {
            document.querySelectorAll('#fluxo .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#fluxo .tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('cf' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.add('active');
        }

        function renderCashFlow() {
            const month = document.getElementById('cashFlowMonth').value;
            if (!month) return;
            const [year, mon] = month.split('-').map(Number);
            const entries = appointments.filter(a => a.paid && !a.cancelled && a.date.startsWith(month));
            const exits = expenses.filter(e => e.date.startsWith(month));
            const totalEntries = entries.reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const totalExits = exits.reduce((s, e) => s + parseFloat(e.value || 0), 0);
            document.getElementById('cfEntries').textContent = 'R$ ' + totalEntries.toFixed(2);
            document.getElementById('cfExits').textContent = 'R$ ' + totalExits.toFixed(2);
            document.getElementById('cfBalance').textContent = 'R$ ' + (totalEntries - totalExits).toFixed(2);
            const entriesBody = document.getElementById('entriesTable');
            entriesBody.innerHTML = '';
            entries.forEach(a => { const p = patients.find(x => x.id === a.patientId); const row = document.createElement('tr'); row.innerHTML = '<td>' + formatDate(a.date) + '</td><td>' + (p ? p.name : '-') + '</td><td>' + a.type + '</td><td>R$ ' + parseFloat(a.value || 0).toFixed(2) + '</td>'; entriesBody.appendChild(row); });
            const exitsBody = document.getElementById('exitsTable');
            exitsBody.innerHTML = '';
            exits.forEach(e => { const row = document.createElement('tr'); row.innerHTML = '<td>' + formatDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.category + '</td><td>R$ ' + parseFloat(e.value).toFixed(2) + '</td><td><button class="btn btn-danger" onclick="deleteExpense(\\'' + e.id + '\\')">Excluir</button></td>'; exitsBody.appendChild(row); });
        }

        function deleteExpense(id) { if (!confirm('Excluir despesa?')) return; expenses = expenses.filter(e => e.id !== id); saveUserData(); renderCashFlow(); }

        function renderReports() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;
            const monthAppts = appointments.filter(a => !a.cancelled && a.date.startsWith(month));
            const revenue = monthAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            document.getElementById('reportSessions').textContent = monthAppts.length;
            document.getElementById('reportRevenue').textContent = 'R$ ' + revenue.toFixed(2);
            const stats = {};
            monthAppts.forEach(a => { if (!stats[a.patientId]) stats[a.patientId] = { count: 0, total: 0 }; stats[a.patientId].count++; if (a.paid) stats[a.patientId].total += parseFloat(a.value || 0); });
            const tbody = document.getElementById('reportTable');
            tbody.innerHTML = '';
            for (let pid in stats) { const p = patients.find(x => x.id === pid); const s = stats[pid]; const row = document.createElement('tr'); row.innerHTML = '<td>' + (p ? p.name : '-') + '</td><td>' + s.count + '</td><td>R$ ' + s.total.toFixed(2) + '</td>'; tbody.appendChild(row); }
        }

        function exportToExcel() {
            let csv = 'Paciente;Data;Servico;Valor;Status\\n';
            appointments.filter(a => !a.cancelled).forEach(a => { const p = patients.find(x => x.id === a.patientId); csv += (p ? p.name : '-') + ';' + formatDate(a.date) + ';' + a.type + ';' + parseFloat(a.value || 0).toFixed(2) + ';' + (a.paid ? 'Pago' : 'Pendente') + '\\n'; });
            const blob = new Blob(['\\uFEFF' + csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ASM_Financeiro_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function formatDate(dateStr) { if (!dateStr) return ''; const parts = dateStr.split('-'); return parts[2] + '/' + parts[1] + '/' + parts[0]; }
        function loadPatientSelect() { const select = document.getElementById('apptPatient'); select.innerHTML = '<option value="">Selecione...</option>'; patients.forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; select.appendChild(opt); }); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        document.querySelectorAll('.modal').forEach(m => { m.onclick = function(e) { if (e.target === this) this.classList.remove('active'); }; });
        checkSession();
    </script>
</body>
</html>



